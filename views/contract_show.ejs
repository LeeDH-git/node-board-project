<link rel="stylesheet" href="/css/style.css">
<main id="contract-show">
<!-- ✅ 카드 1: 계약 기본 정보 (견적상세 첫 카드 느낌) -->
<div class="c-card">
  <div class="c-title">
    <%= contract.title %>
  </div>
  <div class="c-sub">계약 정보 및 누적 기성 현황</div>

  <div class="c-meta">
    <div>
      <div class="c-kv">
        <div class="c-k">계약번호</div>
        <div class="c-v">
          <%= contract.contract_no || "-" %>
        </div>
      </div>
      <div class="c-kv">
        <div class="c-k">발주처</div>
        <div class="c-v">
          <%= contract.client_name || "-" %>
        </div>
      </div>
    </div>

    <div>
      <div class="c-kv">
        <div class="c-k">계약금액</div>
        <div class="c-v">
          <%= contract.total_amount ? contract.total_amount.toLocaleString("ko-KR") + " 원" : "-" %>
        </div>
      </div>
      <div class="c-kv">
        <div class="c-k">등록일</div>
        <div class="c-v">
          <%= contract.created_at ? String(contract.created_at).substring(0,19) : "-" %>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ✅ 카드 2: 요약(견적상세 요약과 동일 결) -->
<div class="c-card">
  <div class="c-section-title">요약</div>

  <div class="c-summary">
    <div class="c-summary-grid">
      <div class="c-sitem">
        <div class="c-sk">계약금액</div>
        <div class="c-sv">
          <%= (contract.progressSummary?.contractTotal || contract.total_amount || 0).toLocaleString("ko-KR") %> 원
        </div>
      </div>

      <div class="c-sitem">
        <div class="c-sk">누적 기성금액</div>
        <div class="c-sv">
          <%= (contract.progressSummary?.sumPaid || 0).toLocaleString("ko-KR") %> 원
        </div>
        <div class="c-ssub">계약 기준 누적 합계</div>
      </div>

      <div class="c-sitem">
        <div class="c-sk">잔액(계약금액 - 누적)</div>
        <div class="c-sv">
          <%= (contract.progressSummary?.balance || 0).toLocaleString("ko-KR") %> 원
        </div>
        <div class="c-ssub">정산/청구 계획 확인</div>
      </div>
    </div>
  </div>

  <div class="c-chips">
    <div class="c-chip"><span class="c-k">공사기간</span>
      <span class="c-v">
        <% if (contract.start_date || contract.end_date) { %>
          <%= contract.start_date || "" %> ~ <%= contract.end_date || "" %>
              <% } else { %>
                -
                <% } %>
      </span>
    </div>
    <div class="c-chip"><span class="c-k">연결 견적 ID</span><span class="c-v">
        <%= contract.estimate_id ? contract.estimate_id : "-" %>
      </span></div>
  </div>
</div>

<!-- ✅ 카드 3: 기성 이력(표 톤 통일) -->
<div class="c-card">
  <div class="c-section-title">기성 이력</div>

  <div class="c-table-wrap">
    <div class="c-scroll">
      <table class="c-table">
        <thead>
          <tr>
            <th style="width:140px;">기성번호</th>
            <th class="c-center" style="width:90px;">기성월</th>
            <th class="c-center" style="width:80px;">기성률</th>
            <th class="c-right" style="width:140px;">기성금액</th>
            <th style="width:260px;">비고</th>
            <th class="c-center" style="width:120px;">등록일</th>
            <th class="c-center" style="width:120px;">관리</th>
          </tr>
        </thead>

        <tbody>
          <% const list=contract.progressHistory || []; %>
            <% if (list.length===0) { %>
              <tr>
                <td colspan="7" class="c-center" style="color:var(--muted); padding:16px;">
                  등록된 기성 이력이 없습니다.
                </td>
              </tr>
              <% } else { %>
                <% list.forEach(p=> { %>
                  <tr>
                    <td><a class="c-link" href="/progress/<%= p.id %>">
                        <%= p.progress_no %>
                      </a></td>
                    <td class="c-center">
                      <%= p.progress_month %>
                    </td>
                    <td class="c-center">
                      <%= (p.progress_rate !=null && p.progress_rate !=="" ) ? (p.progress_rate + "%" ) : "-" %>
                    </td>
                    <td class="c-right">
                      <%= (p.progress_amount || 0).toLocaleString("ko-KR") %> 원
                    </td>
                    <td style="white-space:normal;">
                      <%= p.note || "-" %>
                    </td>
                    <td class="c-center">
                      <%= p.created_at ? String(p.created_at).substring(0,10) : "-" %>
                    </td>
                    <td class="c-center"><a class="c-link" href="/progress/<%= p.id %>/edit">수정</a></td>
                  </tr>
                  <% }) %>
                    <% } %>
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- ✅ 카드 4: PDF/수기 (있을 때만) -->
<% if (contract.pdf_filename || contract.body_text) { %>
  <div class="c-card">
    <% if (contract.pdf_filename) { %>
      <div class="c-section-title">계약서 PDF (1페이지 미리보기)</div>
      <div class="c-pdfbox">
        <embed class="c-embed" src="/uploads/contracts/<%= contract.pdf_filename %>#page=1&zoom=page-width"
          type="application/pdf">
      </div>
      <div style="margin-top:8px;">
        <a class="c-link" href="/uploads/contracts/<%= contract.pdf_filename %>" target="_blank">전체 PDF 새창으로 열기</a>
      </div>
      <% } %>

        <% if (contract.body_text) { %>
          <div style="margin-top:12px;">
            <div class="c-section-title">수기 계약서 내용</div>
            <pre class="c-pre"><%= contract.body_text %></pre>
          </div>
          <% } %>
  </div>
  <% } else { %>
    <div class="c-card">
      <div style="color:var(--muted);">아직 PDF 파일이나 수기 계약서 내용이 등록되지 않았습니다.</div>
    </div>
    <% } %>
</main>
