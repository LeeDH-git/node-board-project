<style>
  :root {
    --bg: #F9FAFB;
    --panel: #FFFFFF;
    --text: #111827;
    --muted: #6B7280;
    --border: #E5E7EB;
    --ring: 0 0 0 4px rgba(17, 24, 39, .14);
  }
  /* ===== 카드(견적상세 톤) ===== */
  .c-card {
    border: 1px solid rgba(17, 24, 39, 0.14);
    border-radius: 12px;
    background: var(--panel);
    padding: 16px;
  }

  .c-card+.c-card {
    margin-top: 12px;
  }

  .c-title {
    margin: 0 0 10px 0;
    font-size: 16px;
    font-weight: 750;
    letter-spacing: -0.01em;
    color: var(--text);
  }

  .c-sub {
    margin: -4px 0 12px 0;
    font-size: 12.5px;
    color: var(--muted);
  }

  /* ===== 상단 정보(견적상세처럼 2열 kv) ===== */
  .c-meta {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
  }

  .c-kv {
    display: grid;
    grid-template-columns: 120px 1fr;
    gap: 8px;
    padding: 10px 0;
    border-bottom: 1px solid rgba(17, 24, 39, 0.10);
  }

  .c-kv:last-child {
    border-bottom: none;
  }

  .c-k {
    color: var(--muted);
    font-size: 12.5px;
    font-weight: 650;
  }

  .c-v {
    color: var(--text);
    font-size: 13.5px;
    font-weight: 650;
    word-break: break-word;
  }

  /* ===== 요약(견적상세처럼 한 줄 3칸) ===== */
  .c-summary {
    border: 1px solid rgba(17, 24, 39, 0.10);
    border-radius: 12px;
    padding: 14px;
    background: #fff;
  }

  .c-summary-grid {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 12px;
    align-items: start;
  }

  .c-sitem {
    padding: 2px 4px;
  }

  .c-sk {
    font-size: 12.5px;
    color: var(--muted);
    font-weight: 750;
    margin-bottom: 6px;
  }

  .c-sv {
    font-size: 18px;
    color: var(--text);
    font-weight: 850;
    letter-spacing: -0.02em;
  }

  .c-ssub {
    margin-top: 6px;
    font-size: 12.5px;
    color: #9CA3AF;
  }

  /* ===== 섹션 타이틀 ===== */
  .c-section-title {
    margin: 0 0 10px 0;
    font-size: 13px;
    font-weight: 750;
    letter-spacing: -0.01em;
    color: var(--text);
  }

  /* ===== 칩 ===== */
  .c-chips {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    margin-top: 8px;
  }

  .c-chip {
    display: inline-flex;
    gap: 6px;
    align-items: center;
    padding: 6px 10px;
    border: 1px solid rgba(17, 24, 39, 0.12);
    border-radius: 999px;
    font-size: 12.5px;
    background: #fff;
  }

  .c-chip .c-k {
    color: var(--muted);
    font-weight: 650;
  }

  .c-chip .c-v {
    color: var(--text);
    font-weight: 750;
  }

  /* ===== 테이블(견적상세 톤) ===== */
  .c-table-wrap {
    margin-top: 10px;
    border: 1px solid rgba(17, 24, 39, 0.14);
    border-radius: 12px;
    background: #fff;
    overflow: hidden;
  }

  .c-scroll {
    overflow-x: auto;
  }

  .c-table {
    width: 100%;
    border-collapse: collapse;
    min-width: 980px;
  }

  .c-table thead th {
    background: var(--bg);
    font-size: 12.5px;
    font-weight: 750;
    padding: 10px 12px;
    border-bottom: 1px solid rgba(17, 24, 39, 0.10);
    text-align: left;
    white-space: nowrap;
  }

  .c-table tbody td {
    font-size: 13px;
    padding: 10px 12px;
    border-bottom: 1px solid rgba(17, 24, 39, 0.08);
    vertical-align: middle;
  }

  .c-table tbody tr:hover {
    background: var(--bg);
  }

  .c-right {
    text-align: right;
    white-space: nowrap;
  }

  .c-center {
    text-align: center;
    white-space: nowrap;
  }

  .c-link {
    color: var(--text);
    text-decoration: none;
    font-weight: 750;
  }

  .c-link:hover {
    text-decoration: underline;
  }

  /* ===== PDF/수기 ===== */
  .c-pdfbox {
    border: 1px solid rgba(17, 24, 39, 0.12);
    border-radius: 12px;
    overflow: hidden;
    background: var(--bg);
  }

  .c-embed {
    width: 100%;
    height: 600px;
    display: block;
    border: 0;
  }

  .c-pre {
    white-space: pre-wrap;
    border: 1px solid rgba(17, 24, 39, 0.12);
    border-radius: 12px;
    padding: 12px;
    background: var(--bg);
    font-size: 13px;
    line-height: 1.7;
    margin: 0;
  }

  @media (max-width: 900px) {
    .c-meta {
      grid-template-columns: 1fr;
    }

    .c-summary-grid {
      grid-template-columns: 1fr;
    }

    .c-embed {
      height: 480px;
    }
  }

  @media (max-width: 520px) {
    .c-kv {
      grid-template-columns: 1fr;
      gap: 6px;
    }

    .c-embed {
      height: 360px;
    }
  }

  /* ===== 페이지 배경(목록과 동일) ===== */
  html, body { background: #F9FAFB !important; }

  /* 레이아웃 래퍼가 흰색을 덮으면 투명 처리 */
  main, .main, .content, .content-wrap, .container {
    background: transparent !important;
  }

  /* ===== 바깥 1겹 카드(c-wrap) 확실히 보이게 ===== */
  .c-wrap{
    box-sizing: border-box !important;
    width: 100% !important;
    max-width: 100% !important;
    margin: 0 !important;

    background: #FFFFFF !important;                 /* ✅ 바깥 카드 흰 배경 */
    border: 1px solid rgba(17,24,39,0.18) !important;/* ✅ 테두리 더 진하게 */
    border-radius: 12px !important;
    padding: 14px !important;
  }

  /* 혹시 상위 overflow 때문에 테두리/라운드가 잘리면 */
  .c-wrap{
    overflow: visible !important;
  }



</style>

<!-- ✅ 카드 1: 계약 기본 정보 (견적상세 첫 카드 느낌) -->
<div class="c-card">
  <div class="c-title">
    <%= contract.title %>
  </div>
  <div class="c-sub">계약 정보 및 누적 기성 현황</div>

  <div class="c-meta">
    <div>
      <div class="c-kv">
        <div class="c-k">계약번호</div>
        <div class="c-v">
          <%= contract.contract_no || "-" %>
        </div>
      </div>
      <div class="c-kv">
        <div class="c-k">발주처</div>
        <div class="c-v">
          <%= contract.client_name || "-" %>
        </div>
      </div>
    </div>

    <div>
      <div class="c-kv">
        <div class="c-k">계약금액</div>
        <div class="c-v">
          <%= contract.total_amount ? contract.total_amount.toLocaleString("ko-KR") + " 원" : "-" %>
        </div>
      </div>
      <div class="c-kv">
        <div class="c-k">등록일</div>
        <div class="c-v">
          <%= contract.created_at ? String(contract.created_at).substring(0,19) : "-" %>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ✅ 카드 2: 요약(견적상세 요약과 동일 결) -->
<div class="c-card">
  <div class="c-section-title">요약</div>

  <div class="c-summary">
    <div class="c-summary-grid">
      <div class="c-sitem">
        <div class="c-sk">계약금액</div>
        <div class="c-sv">
          <%= (contract.progressSummary?.contractTotal || contract.total_amount || 0).toLocaleString("ko-KR") %> 원
        </div>
      </div>

      <div class="c-sitem">
        <div class="c-sk">누적 기성금액</div>
        <div class="c-sv">
          <%= (contract.progressSummary?.sumPaid || 0).toLocaleString("ko-KR") %> 원
        </div>
        <div class="c-ssub">계약 기준 누적 합계</div>
      </div>

      <div class="c-sitem">
        <div class="c-sk">잔액(계약금액 - 누적)</div>
        <div class="c-sv">
          <%= (contract.progressSummary?.balance || 0).toLocaleString("ko-KR") %> 원
        </div>
        <div class="c-ssub">정산/청구 계획 확인</div>
      </div>
    </div>
  </div>

  <div class="c-chips">
    <div class="c-chip"><span class="c-k">공사기간</span>
      <span class="c-v">
        <% if (contract.start_date || contract.end_date) { %>
          <%= contract.start_date || "" %> ~ <%= contract.end_date || "" %>
              <% } else { %>
                -
                <% } %>
      </span>
    </div>
    <div class="c-chip"><span class="c-k">연결 견적 ID</span><span class="c-v">
        <%= contract.estimate_id ? contract.estimate_id : "-" %>
      </span></div>
  </div>
</div>

<!-- ✅ 카드 3: 기성 이력(표 톤 통일) -->
<div class="c-card">
  <div class="c-section-title">기성 이력</div>

  <div class="c-table-wrap">
    <div class="c-scroll">
      <table class="c-table">
        <thead>
          <tr>
            <th style="width:140px;">기성번호</th>
            <th class="c-center" style="width:90px;">기성월</th>
            <th class="c-center" style="width:80px;">기성률</th>
            <th class="c-right" style="width:140px;">기성금액</th>
            <th style="width:260px;">비고</th>
            <th class="c-center" style="width:120px;">등록일</th>
            <th class="c-center" style="width:120px;">관리</th>
          </tr>
        </thead>

        <tbody>
          <% const list=contract.progressHistory || []; %>
            <% if (list.length===0) { %>
              <tr>
                <td colspan="7" class="c-center" style="color:var(--muted); padding:16px;">
                  등록된 기성 이력이 없습니다.
                </td>
              </tr>
              <% } else { %>
                <% list.forEach(p=> { %>
                  <tr>
                    <td><a class="c-link" href="/progress/<%= p.id %>">
                        <%= p.progress_no %>
                      </a></td>
                    <td class="c-center">
                      <%= p.progress_month %>
                    </td>
                    <td class="c-center">
                      <%= (p.progress_rate !=null && p.progress_rate !=="" ) ? (p.progress_rate + "%" ) : "-" %>
                    </td>
                    <td class="c-right">
                      <%= (p.progress_amount || 0).toLocaleString("ko-KR") %> 원
                    </td>
                    <td style="white-space:normal;">
                      <%= p.note || "-" %>
                    </td>
                    <td class="c-center">
                      <%= p.created_at ? String(p.created_at).substring(0,10) : "-" %>
                    </td>
                    <td class="c-center"><a class="c-link" href="/progress/<%= p.id %>/edit">수정</a></td>
                  </tr>
                  <% }) %>
                    <% } %>
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- ✅ 카드 4: PDF/수기 (있을 때만) -->
<% if (contract.pdf_filename || contract.body_text) { %>
  <div class="c-card">
    <% if (contract.pdf_filename) { %>
      <div class="c-section-title">계약서 PDF (1페이지 미리보기)</div>
      <div class="c-pdfbox">
        <embed class="c-embed" src="/uploads/contracts/<%= contract.pdf_filename %>#page=1&zoom=page-width"
          type="application/pdf">
      </div>
      <div style="margin-top:8px;">
        <a class="c-link" href="/uploads/contracts/<%= contract.pdf_filename %>" target="_blank">전체 PDF 새창으로 열기</a>
      </div>
      <% } %>

        <% if (contract.body_text) { %>
          <div style="margin-top:12px;">
            <div class="c-section-title">수기 계약서 내용</div>
            <pre class="c-pre"><%= contract.body_text %></pre>
          </div>
          <% } %>
  </div>
  <% } else { %>
    <div class="c-card">
      <div style="color:var(--muted);">아직 PDF 파일이나 수기 계약서 내용이 등록되지 않았습니다.</div>
    </div>
    <% } %>