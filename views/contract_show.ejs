<style>
  :root{
    --bg: var(--bg, #F9FAFB);
    --panel: var(--panel, #FFFFFF);
    --text: var(--text, #111827);
    --muted: var(--muted, #6B7280);
    --border: var(--border, #E5E7EB);
    --ring: var(--ring, 0 0 0 4px rgba(17,24,39,.14));
  }

  .card{
    border: 1px solid var(--border);
    border-radius: 12px;
    background: var(--panel);
    padding: 16px;
  }
  .card + .card{ margin-top: 12px; }

  .title{
    margin: 0 0 10px 0;
    font-size: 16px;
    font-weight: 650;
    letter-spacing: -0.01em;
  }

  .meta-grid{
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
  }

  .kv{
    display:grid;
    grid-template-columns: 120px 1fr;
    gap: 8px;
    padding: 10px 0;
    border-bottom: 1px solid var(--border);
  }
  .kv:last-child{ border-bottom: none; }
  .k{ color: var(--muted); font-size: 12.5px; }
  .v{ color: var(--text); font-size: 13.5px; font-weight: 550; word-break: break-word; }

  .section-title{
    margin: 0 0 10px 0;
    font-size: 13px;
    font-weight: 650;
    letter-spacing: -0.01em;
  }

  .pdf-box{
    border: 1px solid var(--border);
    border-radius: 12px;
    overflow: hidden;
    background: var(--bg);
  }
  .pdf-embed{
    width: 100%;
    height: 600px;
    display:block;
    border:0;
  }

  .pre{
    white-space: pre-wrap;
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 12px;
    background: var(--bg);
    font-size: 13px;
    line-height: 1.7;
    margin: 0;
  }

  .chips{
    display:flex;
    gap:8px;
    flex-wrap:wrap;
    margin-top:8px;
  }
  .chip{
    display:inline-flex;
    gap:6px;
    align-items:center;
    padding:6px 10px;
    border:1px solid var(--border);
    border-radius:999px;
    font-size:12.5px;
    background:#fff;
  }
  .chip .k{ color: var(--muted); }
  .chip .v{ font-weight:650; color:var(--text); }

  .table-wrap{
    border: 1px solid var(--border);
    border-radius: 12px;
    overflow: hidden;
    background: #fff;
    margin-top: 10px;
  }
  .table{
    width: 100%;
    border-collapse: collapse;
    min-width: 980px;
  }
  .table thead th{
    background: var(--bg);
    font-size: 12.5px;
    font-weight: 650;
    padding: 10px 12px;
    border-bottom: 1px solid var(--border);
    text-align: left;
    white-space: nowrap;
  }
  .table tbody td{
    font-size: 13px;
    padding: 10px 12px;
    border-bottom: 1px solid var(--border);
    white-space: nowrap;
  }
  .table tbody tr:hover{ background: var(--bg); }
  .text-right{ text-align:right; }
  .text-center{ text-align:center; }

  @media (max-width: 900px){
    .meta-grid{ grid-template-columns: 1fr; }
    .pdf-embed{ height: 480px; }
  }
  @media (max-width: 520px){
    .kv{ grid-template-columns: 1fr; }
    .pdf-embed{ height: 360px; }
  }
</style>

<div class="card">
  <div class="title"><%= contract.title %></div>

  <div class="meta-grid">
    <div>
      <div class="kv">
        <div class="k">계약번호</div>
        <div class="v"><%= contract.contract_no || "-" %></div>
      </div>
      <div class="kv">
        <div class="k">발주처</div>
        <div class="v"><%= contract.client_name || "-" %></div>
      </div>
      <div class="kv">
        <div class="k">계약금액</div>
        <div class="v">
          <%= contract.total_amount ? contract.total_amount.toLocaleString("ko-KR") + " 원" : "-" %>
        </div>
      </div>
    </div>

    <div>
      <div class="kv">
        <div class="k">공사기간</div>
        <div class="v">
          <% if (contract.start_date || contract.end_date) { %>
            <%= contract.start_date || "" %> ~ <%= contract.end_date || "" %>
          <% } else { %>
            -
          <% } %>
        </div>
      </div>

      <div class="kv">
        <div class="k">연결 견적 ID</div>
        <div class="v"><%= contract.estimate_id ? contract.estimate_id : "-" %></div>
      </div>

      <div class="kv">
        <div class="k">등록일</div>
        <div class="v"><%= contract.created_at ? String(contract.created_at).substring(0, 19) : "-" %></div>
      </div>
    </div>
  </div>
</div>

<div class="card">
  <div class="section-title">기성 이력</div>

  <div class="chips">
    <div class="chip"><span class="k">누적 기성</span><span class="v"><%= (contract.progressSummary?.sumPaid || 0).toLocaleString("ko-KR") %> 원</span></div>
    <div class="chip"><span class="k">계약금액</span><span class="v"><%= (contract.progressSummary?.contractTotal || 0).toLocaleString("ko-KR") %> 원</span></div>
    <div class="chip"><span class="k">잔액</span><span class="v"><%= (contract.progressSummary?.balance || 0).toLocaleString("ko-KR") %> 원</span></div>
  </div>

  <div class="table-wrap" style="overflow-x:auto;">
    <table class="table">
      <thead>
        <tr>
          <th style="width:140px;">기성번호</th>
          <th class="text-center" style="width:90px;">기성월</th>
          <th class="text-center" style="width:80px;">기성률</th>
          <th class="text-right"  style="width:140px;">기성금액</th>
          <th style="width:220px;">비고</th>
          <th class="text-center" style="width:120px;">등록일</th>
          <th class="text-center" style="width:120px;">관리</th>
        </tr>
      </thead>

      <tbody>
        <% const list = contract.progressHistory || []; %>
        <% if (list.length === 0) { %>
          <tr>
            <td colspan="7" class="text-center" style="color:var(--muted); padding:16px;">
              등록된 기성 이력이 없습니다.
            </td>
          </tr>
        <% } else { %>
          <% list.forEach(p => { %>
            <tr>
              <td><a class="link" href="/progress/<%= p.id %>"><%= p.progress_no %></a></td>
              <td class="text-center"><%= p.progress_month %></td>
              <td class="text-center"><%= (p.progress_rate != null && p.progress_rate !== "") ? (p.progress_rate + "%") : "-" %></td>
              <td class="text-right"><%= (p.progress_amount || 0).toLocaleString("ko-KR") %> 원</td>
              <td style="white-space:normal;"><%= p.note || "-" %></td>
              <td class="text-center"><%= p.created_at ? String(p.created_at).substring(0,10) : "-" %></td>
              <td class="text-center"><a class="link" href="/progress/<%= p.id %>/edit">수정</a></td>
            </tr>
          <% }) %>
        <% } %>
      </tbody>
    </table>
  </div>
</div>

<% if (contract.pdf_filename || contract.body_text) { %>
  <div class="card">
    <% if (contract.pdf_filename) { %>
      <div class="section-title">계약서 PDF (1페이지 미리보기)</div>
      <div class="pdf-box">
        <embed class="pdf-embed"
               src="/uploads/contracts/<%= contract.pdf_filename %>#page=1&zoom=page-width"
               type="application/pdf">
      </div>
      <div style="margin-top: 8px;">
        <a class="link" href="/uploads/contracts/<%= contract.pdf_filename %>" target="_blank">
          전체 PDF 새창으로 열기
        </a>
      </div>
    <% } %>

    <% if (contract.body_text) { %>
      <div style="margin-top: 12px;">
        <div class="section-title">수기 계약서 내용</div>
        <pre class="pre"><%= contract.body_text %></pre>
      </div>
    <% } %>
  </div>
<% } else { %>
  <div class="card">
    <div style="color:var(--muted);">아직 PDF 파일이나 수기 계약서 내용이 등록되지 않았습니다.</div>
  </div>
<% } %>
