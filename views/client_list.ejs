<link rel="stylesheet" href="/css/style.css">

<main id="client_list">
<!-- ✅ 툴바 (contract_list.ejs 동일 패턴) -->
<div class="toolbar">
  <form method="get" action="/client" class="search-form">
    <input type="text" name="q" placeholder="거래처명/사업자번호/전화 검색" value="<%= (typeof q !== 'undefined' ? q : '') %>" />
    <button class="btn" type="submit">검색</button>
    <button class="btn" type="button" onclick="window.location.href='/client'">새로고침</button>
  </form>

  <div class="toolbar-right">
    <a href="/" class="btn">메인</a>
    <button type="button" class="btn" id="btnBulkClientOpen">거래처 일괄등록</button>
    <a href="/client/new" class="btn btn-primary">거래처 등록</a>
  </div>
</div>

<div class="table-scroll">
  <table>
    <thead>
      <tr>
        <th class="text-center" style="width:80px;">ID</th>
        <th>거래처명</th>
        <th class="text-center" style="width:180px;">사업자번호</th>
        <th class="text-center" style="width:140px;">대표자</th>
        <th class="text-center" style="width:160px;">전화</th>
        <th class="text-center" style="width:110px;">관리</th>
      </tr>
    </thead>

    <tbody>
      <% if (clients && clients.length> 0) { %>
        <% clients.forEach((c)=> { %>
          <tr>
            <td class="text-center">
              <%= c.id %>
            </td>

            <td class="nowrap">
              <!-- 기존 상세 페이지가 있다면 링크로 바꾸세요. (예: /client/<%= c.id %>) -->
              <a class="link" href="/client/<%= c.id %>">
                <%= c.name || '' %>
              </a>
            </td>

            <td class="text-center nowrap">
              <%= c.biz_no || '' %>
            </td>
            <td class="text-center nowrap">
              <%= c.ceo_name || '' %>
            </td>
            <td class="text-center nowrap">
              <%= c.phone || '' %>
            </td>

            <td class="text-center">
              <div class="action-buttons">
                <a href="/client/<%= c.id %>/edit" class="icon-btn" title="수정" aria-label="수정">
                  <img src="/icons/edit.png" alt="수정" />
                </a>

                <form method="post" action="/client/<%= c.id %>/delete" style="display:inline;">
                  <button type="submit" class="icon-btn" title="삭제" aria-label="삭제"
                    onclick="return confirm('삭제하시겠습니까?');">
                    <img src="/icons/delete.png" alt="삭제" />
                  </button>
                </form>
              </div>
            </td>
          </tr>
          <% }) %>
            <% } else { %>
              <tr>
                <td colspan="6" class="text-center" style="color: var(--muted); padding: 18px;">
                  등록된 거래처가 없습니다.
                </td>
              </tr>
              <% } %>
    </tbody>
  </table>
</div>

<% if (totalPages && totalPages> 1) { %>
  <div class="pagination" aria-label="Client pagination">
    <% for (let p=1; p <=totalPages; p++) { %>
      <% if (p===page) { %>
        <a class="page current">
          <%= p %>
        </a>
        <% } else { %>
          <a class="page" href="/client?page=<%= p %><%= q ? '&q=' + encodeURIComponent(q) : '' %>">
            <%= p %>
          </a>
          <% } %>
            <% } %>
  </div>
  <% } %>

    <!-- ✅ 거래처 일괄등록 모달 -->
    <div class="modal" id="bulkClientModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
    
          <div class="modal-header">
            <h5 class="modal-title">거래처 일괄등록</h5>
            <button type="button" class="btn-close" data-close="modal" aria-label="Close"></button>
          </div>
    
          <div class="modal-body">
            <div class="alert alert-secondary">
              1) 엑셀 양식을 다운로드 후<br />
              2) 작성한 파일을 업로드하면 거래처가 일괄 등록됩니다.
            </div>
    
            <div class="d-flex gap-2 mb-3">
              <a class="btn btn-outline-secondary" href="/client/template">엑셀 양식 다운로드</a>
            </div>
    
            <form id="bulkClientForm" action="/client/upload" method="post" enctype="multipart/form-data">
              <div class="mb-2">
                <label class="form-label">엑셀 파일 선택</label>
                <input class="form-control" type="file" name="file" accept=".xlsx,.xls" required>
              </div>
    
              <div class="d-flex gap-2">
                <button type="submit" class="btn btn-primary">엑셀 업로드</button>
                <button type="button" class="btn btn-light" data-close="modal">취소</button>
              </div>
            </form>
          </div>
    
        </div>
      </div>
    </div>
    </main>

    <script>
      (function () {
        const openBtn = document.getElementById('btnBulkClientOpen');
        const modal = document.getElementById('bulkClientModal');
        if (!openBtn || !modal) return;

        function openModal() {
          modal.style.display = 'block';
          modal.classList.add('show');
          document.body.style.overflow = 'hidden';
        }

        function closeModal() {
          modal.style.display = 'none';
          modal.classList.remove('show');
          document.body.style.overflow = '';
        }

        openBtn.addEventListener('click', openModal);

        modal.addEventListener('click', (e) => {
          if (e.target === modal) closeModal();
        });

        modal.querySelectorAll('[data-close="modal"]').forEach(btn => {
          btn.addEventListener('click', closeModal);
        });

        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape' && modal.classList.contains('show')) closeModal();
        });
      })();
    </script>