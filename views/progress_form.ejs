<!-- views/progress_form.ejs -->
<style>
  :root {
    --bg: var(--bg, #F9FAFB);
    --panel: var(--panel, #FFFFFF);
    --text: var(--text, #111827);
    --muted: var(--muted, #6B7280);
    --border: var(--border, #E5E7EB);
    --ring: var(--ring, 0 0 0 4px rgba(17, 24, 39, .14));
  }

  .section {
    border: 1px solid var(--border);
    border-radius: 12px;
    background: var(--panel);
    padding: 16px;
    margin-bottom: 12px;
  }

  .section-title {
    margin: 0 0 10px 0;
    font-size: 13px;
    font-weight: 650;
    letter-spacing: -0.01em;
    color: var(--text);
  }

  .help {
    margin: 6px 0 0;
    font-size: 12px;
    color: #9CA3AF;
    line-height: 1.5;
  }

  .grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
  }

  .span-2 {
    grid-column: 1 / span 2;
  }

  .field {
    display: flex;
    flex-direction: column;
    gap: 6px;
    padding: 10px 0;
    border-bottom: 1px solid var(--border);
  }

  .grid>.field:nth-last-child(-n+2) {
    border-bottom: none;
  }

  .label {
    font-size: 12px;
    color: var(--muted);
    font-weight: 700;
  }

  .req {
    color: #ef4444;
    font-weight: 700;
  }

  .input,
  .select,
  .textarea {
    border: 1px solid var(--border);
    border-radius: 10px;
    background: #fff;
    padding: 0 12px;
    height: 40px;
    font-size: 13.5px;
    color: var(--text);
  }

  .textarea {
    height: auto;
    padding: 10px 12px;
    min-height: 120px;
    resize: vertical;
  }

  .input:focus,
  .select:focus,
  .textarea:focus {
    outline: none;
    border-color: var(--text);
    box-shadow: var(--ring);
  }

  .input[readonly] {
    background: var(--bg);
  }

  .alert {
    border: 1px solid #fecaca;
    background: #fff1f2;
    color: #991b1b;
    border-radius: 12px;
    padding: 12px 14px;
    font-size: 13px;
    margin-bottom: 12px;
  }

  .footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 10px;
    flex-wrap: wrap;
    margin-top: 14px;
  }

  .footer-right {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    align-items: center;
    justify-content: flex-end;
  }

  @media (max-width: 760px) {
    .grid {
      grid-template-columns: 1fr;
    }

    .span-2 {
      grid-column: auto;
    }
  }
</style>

<% if (error) { %>
  <div class="alert">
    <%= error %>
  </div>
  <% } %>

    <form method="post" action="<%= mode === 'edit' ? ('/progress/' + progress.id + '/edit') : '/progress' %>">
      <div class="section">
        <div class="section-title">기성 기본정보</div>

        <div class="grid">
          <div class="field span-2">
            <div class="label">계약 선택 <span class="req">*</span></div>
            <select class="select" name="contract_id" id="contract_id" required>
              <option value="">-- 계약 선택 --</option>
              <% (contracts || []).forEach((c)=> { %>
                <option value="<%= c.id %>" data-total="<%= c.total_amount || 0 %>" <%=String(progress.contract_id || ''
                  )===String(c.id) ? 'selected' : '' %>
                  >
                  <%= (c.contract_no ? '[' + c.contract_no + '] ' : '' ) %>
                    <%= c.title %>
                      <%= c.client_name ? ' / ' + c.client_name : '' %>
                </option>
                <% }) %>
            </select>
            <div class="help">기성은 계약 단위로 관리됩니다.</div>
          </div>

          <div class="field">
            <div class="label">기성월(YYYY-MM) <span class="req">*</span></div>
            <input class="input" type="month" name="progress_month" id="progress_month"
              value="<%= progress.progress_month || '' %>" required />
            <div class="help">월별 중복 등록은 제한됩니다.</div>
          </div>

          <div class="field">
            <div class="label">기성률(%)</div>
            <input class="input" type="number" step="0.01" name="progress_rate" id="progress_rate"
              value="<%= (progress.progress_rate === null || progress.progress_rate === undefined) ? '' : progress.progress_rate %>"
              placeholder="예: 12.50" />
            <div class="help">기성률을 입력하면 기성금액은 계약금액 기준으로 자동 계산됩니다.</div>
          </div>

          <div class="field span-2">
            <div class="label">기성금액(원)</div>
            <input class="input" type="text" name="progress_amount" id="progress_amount"
              value="<%= progress.progress_amount ? Number(progress.progress_amount).toLocaleString('ko-KR') : '' %>"
              placeholder="직접 입력 가능 (콤마 허용)" />
            <div class="help">기성률을 입력한 경우 서버 저장 시 자동 계산이 우선 적용됩니다.</div>
          </div>

          <div class="field span-2" style="border-bottom:none;">
            <div class="label">비고</div>
            <textarea class="textarea" name="note" placeholder="특이사항, 정산 조건 등"><%= progress.note || '' %></textarea>
          </div>
        </div>
      </div>

      <div class="footer">
        <div class="footer-left" style="color:var(--muted); font-size:12.5px;">
          <%= mode==='edit' ? '수정 후 저장하면 기존 데이터가 업데이트됩니다.' : '저장 후 상세 화면에서 누적 현황을 확인할 수 있습니다.' %>
        </div>

        <div class="footer-right">
          <a href="/progress" class="btn">취소</a>
          <button type="submit" class="btn btn-primary">
            <%= mode==='edit' ? '수정 저장' : '등록 저장' %>
          </button>
        </div>
      </div>
    </form>

    <script>
      function toNumberLoose(v) {
        const s = String(v || "").replace(/,/g, "").trim();
        if (!s) return 0;
        const n = Number(s);
        return Number.isNaN(n) ? 0 : n;
      }
      function formatKRW(n) {
        try { return Number(n || 0).toLocaleString("ko-KR"); }
        catch (e) { return String(n || 0); }
      }

      const contractSel = document.getElementById("contract_id");
      const rateInput = document.getElementById("progress_rate");
      const amtInput = document.getElementById("progress_amount");

      function recalc() {
        const opt = contractSel.options[contractSel.selectedIndex];
        const total = opt ? toNumberLoose(opt.getAttribute("data-total")) : 0;
        const rate = String(rateInput.value || "").trim();

        if (!rate) return; // rate 없으면 자동 계산 안함

        const r = Number(rate);
        if (Number.isNaN(r)) return;

        const auto = Math.round(total * r / 100);
        amtInput.value = formatKRW(auto);
      }

      // 사용자 입력 편의: 금액 입력 시 콤마 유지
      amtInput.addEventListener("blur", () => {
        const n = toNumberLoose(amtInput.value);
        if (n) amtInput.value = formatKRW(n);
      });

      rateInput.addEventListener("input", recalc);
      contractSel.addEventListener("change", recalc);
    </script>