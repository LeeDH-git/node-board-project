<style>
  /* 페이지 전용(최소) - layout.ejs 토큰(색/보더)을 그대로 활용 */
  .page-head{
    display:flex;
    align-items:flex-start;
    justify-content:space-between;
    gap:12px;
    margin-bottom: 14px;
    flex-wrap: wrap; /* 해상도 작으면 자동 줄바꿈 */
  }

  .page-head h2{
    margin:0;
    font-size: 18px;
    font-weight: 650;
    letter-spacing: -0.01em;
  }
  .page-head .sub{
    margin: 2px 0 0;
    font-size: 12.5px;
    color: var(--muted);
  }

  .head-actions{
    display:flex;
    gap:8px;
    flex-wrap: wrap;
    align-items:center;
    justify-content:flex-end;
  }

  .search-form{
    display:flex;
    gap:8px;
    flex-wrap: wrap;
    align-items:center;
  }
  .search-form input[type="text"]{
    height: 36px;
    padding: 0 12px;
    border-radius: 10px;
    border: 1px solid var(--border);
    background: #fff;
    min-width: 220px;
  }
  .search-form input[type="text"]:focus{
    outline:none;
    border-color: var(--text);
    box-shadow: var(--ring);
  }

  /* 테이블: 작아지면 가로 스크롤로 안전하게 */
  .table-scroll{
    overflow-x:auto;
    border: 1px solid var(--border);
    border-radius: 12px;
    background: #fff;
  }

  table{
    width:100%;
    border-collapse: collapse;
    min-width: 760px; /* 너무 좁아지면 스크롤로 */
  }
  thead th{
    background: var(--bg);
    color: var(--text);
    font-weight: 600;
    font-size: 12.5px;
    padding: 10px 12px;
    border-bottom: 1px solid var(--border);
    text-align:left;
    white-space: nowrap;
  }
  tbody td{
    font-size: 13px;
    padding: 10px 12px;
    border-bottom: 1px solid var(--border);
    vertical-align: middle;
  }
  tbody tr:hover{
    background: var(--bg);
  }

  .text-right{ text-align:right; }
  .text-center{ text-align:center; }

  /* 링크 스타일 - 콘솔 톤 */
  .link{
    color: var(--text);
    text-decoration:none;
    font-weight: 600;
  }
  .link:hover{
    text-decoration: underline;
  }

  /* 아이콘 버튼: 크기/정렬 통일 */
  .action-buttons{
    display:flex;
    gap:6px;
    white-space: nowrap;
    justify-content: flex-start;
  }
  .icon-btn{
    width: 34px;
    height: 34px;
    border-radius: 10px;
    border: 1px solid var(--border);
    background: #fff;
    display:inline-flex;
    align-items:center;
    justify-content:center;
    cursor:pointer;
    padding:0;
  }
  .icon-btn:hover{ background: var(--bg); }
  .icon-btn img{ width: 16px; height: 16px; display:block; }

  /* 페이징 - 콘솔 톤 */
  .pagination{
    margin-top: 12px;
    display:flex;
    gap:6px;
    justify-content:center;
    flex-wrap: wrap;
  }
  .page{
    min-width: 30px;
    height: 32px;
    padding: 0 10px;
    display:inline-flex;
    align-items:center;
    justify-content:center;
    border: 1px solid var(--border);
    border-radius: 10px;
    background:#fff;
    color: var(--text);
    font-size: 12.5px;
    text-decoration:none;
  }
  .page:hover{ background: var(--bg); }
  .page.current{
    background: var(--text);
    border-color: var(--text);
    color: #fff;
    font-weight: 650;
  }
</style>

<div class="page-head">
  <div>
    <h2>견적관리</h2>
    <div class="sub">공사별·거래처별 견적 등록 / 조회</div>
  </div>

  <div class="head-actions">
    <a href="/" class="btn">메인</a>
    <a href="/estimate/new" class="btn btn-primary">견적 등록</a>
  </div>

  <form method="GET" action="/estimate" class="search-form" style="width:100%;">
    <input
      type="text"
      name="q"
      placeholder="견적명 검색"
      value="<%= (typeof searchQuery !== 'undefined' ? searchQuery : '') %>"
    />
    <button type="submit" class="btn">검색</button>
    <button type="button" class="btn" onclick="window.location.href='/estimate'">새로고침</button>
  </form>
</div>

<% if (!estimates || estimates.length === 0) { %>
  <div style="color: var(--muted); font-size: 13px;">
    등록된 견적이 없습니다. 우측의 “견적 등록” 버튼으로 추가하세요.
  </div>
<% } else { %>

  <div class="table-scroll">
    <table>
      <thead>
        <tr>
          <th style="width:70px;">번호</th>
          <th>견적명</th>
          <th style="width:120px;">거래처</th>
          <th style="width:140px;" class="text-right">견적금액</th>
          <th style="width:110px;" class="text-center">등록일</th>
          <th style="width:140px;"></th>
        </tr>
      </thead>

      <tbody>
        <% estimates.forEach((e) => { %>
          <tr>
            <td class="text-center"><%= e.row_no %></td>

            <td>
              <a class="link" href="/estimate/<%= e.id %>"><%= e.title %></a>
            </td>

            <td class="text-center"><%= e.client_name || "" %></td>

            <td class="text-right">
              <%= e.total_amount ? e.total_amount.toLocaleString("ko-KR") : "" %>
            </td>

            <td class="text-center">
              <%= e.created_at.slice(0,10).replace(/-/g, ".") %>
            </td>

            <td>
              <div class="action-buttons">
                <a href="/estimate/<%= e.id %>/edit" class="icon-btn" title="수정">
                  <img src="/icons/edit.png" alt="수정" />
                </a>

                <button type="button" class="icon-btn" title="복사" onclick="copyEstimate(<%= e.id %>)">
                  <img src="/icons/copy.png" alt="복사" />
                </button>

                <button type="button" class="icon-btn" title="삭제" onclick="deleteEstimate(<%= e.id %>)">
                  <img src="/icons/delete.png" alt="삭제" />
                </button>
              </div>
            </td>
          </tr>
        <% }) %>
      </tbody>
    </table>
  </div>

  <% if (totalPages > 1) { %>
    <div class="pagination">
      <% for (let p = 1; p <= totalPages; p++) { %>
        <% if (p === currentPage) { %>
          <span class="page current"><%= p %></span>
        <% } else { %>
          <a class="page"
             href="/estimate?page=<%= p %><%= searchQuery ? '&q=' + encodeURIComponent(searchQuery) : '' %>">
            <%= p %>
          </a>
        <% } %>
      <% } %>
    </div>
  <% } %>

<% } %>

<script>
  function copyEstimate(id) {
    if (!confirm("해당 건의 견적서를 복사하시겠습니까?")) return;

    fetch(`/estimate/${id}/copy`, { method: "POST" })
      .then(res => {
        if (res.redirected) window.location.href = res.url;
        else alert("복사 처리 중 오류가 발생했습니다.");
      });
  }

  function deleteEstimate(id) {
    if (!confirm("정말로 이 견적을 삭제하시겠습니까?")) return;

    fetch(`/estimate/${id}/delete`, { method: "POST" })
      .then(res => {
        if (res.redirected) window.location.href = res.url;
        else alert("삭제 처리 중 오류가 발생했습니다.");
      });
  }
</script>
