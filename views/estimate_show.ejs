<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ê²¬ì  ìƒì„¸</title>
  <style>
    body { 
      font-family: system-ui;
      background: #f5f5f5;
      margin: 0; 
    }
    /* ê²¬ì ì„œ ì „ì²´ í”„ë ˆì„ */
    .estimate-wrap {
      max-width: 1450px;
      margin: 24px auto 40px;
      background: #ffffff;
      padding: 20px 24px 28px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.06);
      box-sizing: border-box;
      overflow-x: hidden;
    }

    h1 { text-align: center; margin: 0 0 20px 0; }
    .header-row {
      margin-bottom: 12px;
      font-size: 14px;
    }
    .header-row label {
      font-weight: 600;
      margin-right: 6px;
    }
    .header-row input[type="text"] {
      width: 400px;
      padding: 4px 6px;
      border:1px solid #ccc;
      border-radius:4px;
      font-size:13px;
      background: #f7f7f7;
    }
    .header-input { text-align: left !important; }
    
    /* í™”ë©´ì—ì„œ ë³¼ ë•Œë§Œ ë„“ê²Œ(1400px) */
    @media screen {
      table {
        width: 1400px;
        border-collapse: collapse;
        font-size: 11px;
        table-layout: fixed;
      }
    }
    th, td {
      border: 1px solid #999;
      padding: 3px 4px;
      text-align: center;
      vertical-align: middle;
    }

    th.col-name, td.col-name { width: 17%; }
    th.col-spec, td.col-spec { width: 15%; }
    th.col-unit, td.col-unit { width: 4%;  }
    th.col-qty,  td.col-qty  { width: 5%;  }

    th.col-mu,  td.col-mu,
    th.col-ma,  td.col-ma,
    th.col-lu,  td.col-lu,
    th.col-la,  td.col-la,
    th.col-eu,  td.col-eu,
    th.col-ea,  td.col-ea,
    th.col-tu,  td.col-tu,
    th.col-ta,  td.col-ta { width: 6%; }

    th.col-note, td.col-note { width: 5%; }

    td input {
      width: 100%;
      box-sizing: border-box;
      border: none;
      padding: 1px 2px;
      font-size: 11px;
      background: #f7f7f7;
    }

    td.col-name input,
    td.col-spec input {
      text-align: left;
    }

    td.col-qty    input,
    td.col-mu     input,
    td.col-ma     input,
    td.col-lu     input,
    td.col-la     input,
    td.col-eu     input,
    td.col-ea     input,
    td.col-tu     input,
    td.col-ta     input {
      text-align: right;
    }

    /* í•©ê³„ í–‰ ìŠ¤íƒ€ì¼ */
    tr.total-row td {
      font-weight: 700;      /* ìˆ«ì êµµê²Œ */
    }

    /* í’ˆëª… ì¹¸ íšŒìƒ‰ ë°°ê²½ + ì™¼ìª½ ì •ë ¬ */
    td.total-label {
      background: #eeeeee;
      text-align: left;
    }

    thead th {
      background: #ddebf7;
      font-weight: 600;
    }
    .sub-header { background: #ddebf7; }

    input[readonly] { background: #f7f7f7; }

    .text-left { text-align:left; }
    .text-left input { text-align:left; }

    .actions {
      margin-top: 16px;
      display:flex;
      gap:8px;
      justify-content: center;
    }
    .btn {
      padding: 6px 12px;
      border-radius: 4px;
      border: 1px solid #007bff;
      background: #007bff;
      color: #fff;
      font-size: 13px;
      cursor: pointer;
    }
    .btn-outline {
      background:#fff;
      color:#007bff;
    }
    a { text-decoration:none; }

   
    /* ì¸ì‡„ ì„¤ì • (A4 ê°€ë¡œ + í—¤ë”/í‘¸í„° ì œê±°) */
    @page {
      size: A4 landscape;
      margin: 0;  /* ë¸Œë¼ìš°ì € ê¸°ë³¸ í—¤ë”/í‘¸í„° ì œê±° */
    }

    @media print {

      /* ì¸ì‡„ ì‹œ ë°°ê²½ ë° ìƒ‰ ìœ ì§€ */
      body {
        margin: 12mm !important;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
      }

      /* í™”ë©´ UI ìš”ì†Œ ì œê±° */
      .actions,
      .btn,
      header,
      nav,
      footer {
        display: none !important;
      }

      /* ì¸ì‡„ í˜ì´ì§€ ì œëª© ì œê±° */
      title { display: none !important; }

      /* URL / ë‚ ì§œ/ì‹œê°„ ë“± ê¸°ë³¸ footer ì œê±° íš¨ê³¼ */
      * {
        -webkit-margin-before: 0 !important;
        -webkit-margin-after: 0 !important;
      }

      /* ê²¬ì ì„œ ë‚´ë¶€ëŠ” í˜ì´ì§€ ë‚˜ëˆ” ìë™ ë°©ì§€ */
      table, tr, td, th {
        page-break-inside: avoid;
      }
      
      /* ğŸ‘‰ ì¸ì‡„ ì‹œ í…Œì´ë¸”ì€ ìš©ì§€ í­ 100% ì‚¬ìš© */
      table {
        width: 100% !important;
        border-collapse: collapse;
        border: 0.5pt solid #999;      /* ì „ì²´ í…Œì´ë¸” ì™¸ê³½ì„  */
      }

      /* ğŸ‘‰ ê° ì…€ì€ ê°€ë¡œ/ì„¸ë¡œ ì¤„ ëª¨ë‘ ìœ ì§€ (ì¢€ ë” ì–‡ê³  ì˜…ê²Œ) */
      th, td {
        border: 0.5pt solid #ccc;      /* ì„¸ë¡œì¤„ í¬í•¨ ì „ì²´ ê·¸ë¦¬ë“œ */
        padding: 2px 3px;
        font-size: 10px;               /* í™”ë©´ë³´ë‹¤ ì‚´ì§ ì¤„ì—¬ì„œ ê¸ˆì•¡ì´ ì•ˆ ì§¤ë¦¬ê²Œ */
        box-sizing: border-box;
      }

      /* í–‰ë§ˆë‹¤ ê°€ë¡œì¤„ë§Œ ì–‡ê²Œ */
      tbody tr {
        border-bottom: 0.5pt solid #bbb;
      }

      thead tr {
        border-bottom: 1pt solid #666;
      }

      /* ğŸ‘‰ ì…ë ¥ì¹¸ ëŠë‚Œ ì—†ì• ë˜, ìˆ«ìê°€ ì˜ ì•ˆ ì§¤ë¦¬ê²Œ */
      input[type="text"],
      input[type="number"] {
        width: 100%;
        border: none;
        background: transparent;
        box-shadow: none;
        padding: 0 2px;
        font-size: 10px;               /* í…Œì´ë¸”ê³¼ ë§ì¶¤ */
        box-sizing: border-box;
      }
      
      /* ìˆ«ì(ë‹¨ê°€/ê¸ˆì•¡) ì¹¸ì€ ì˜¤ë¥¸ìª½ ì •ë ¬ ìœ ì§€ */
      .col-qty    input,
      .col-mu     input,
      .col-ma     input,
      .col-lu     input,
      .col-la     input,
      .col-eu     input,
      .col-ea     input,
      .col-tu     input,
      .col-ta     input {
        text-align: right;
      }

      /* ê²¬ì ì„œ ì „ì²´ë¥¼ ê½‰ ì±„ìš°ê¸° */
      .estimate-wrap {
        margin: 0 !important;
        box-shadow: none !important;
        border: none !important;
        width: 100% !important;
      }
    }

    /* ê³µì‚¬ëª… / ë°œì£¼ì²˜ëŠ” ë°•ìŠ¤ ì—†ì´ ê¸€ìì²˜ëŸ¼ ë³´ì´ê²Œ */
    .header-row input[type="text"] {
      border: none !important;          /* í…Œë‘ë¦¬ ì œê±° */
      background: transparent !important;/* ë°°ê²½ìƒ‰ ì œê±° */
      box-shadow: none !important;      /* ê·¸ë¦¼ì ì œê±° */
      padding: 0 !important;            /* ì•ˆìª½ ì—¬ë°± ì œê±° */
      width: auto !important;           /* ê³ ì •í­(400px) ì—†ì• ê³  ë‚´ìš© ê¸¸ì´ë§Œí¼ë§Œ */
      font-size: 14px;                  /* í•„ìš”í•˜ë©´ ì¡°ì • */
    }

  </style>
</head>
<body>
  <% 
    function fmt(n) {
      if (n === null || n === undefined || n === "") return "";
      const num = Number(n);
      if (isNaN(num)) return n;
      return num.toLocaleString("ko-KR");
    }
  %>
  <div class="estimate-wrap">
    <h1>ê²¬ ì  ë‚´ ì—­ ì„œ</h1>

    <div class="header-row">
      <label for="title">ê³µì‚¬ëª… :</label>
      <input type="text" id="title" class="header-input" readonly
        value="<%= estimate.title %>" />
      &nbsp;&nbsp;
      <label for="client_name">ë°œì£¼ì²˜ :</label>
      <input type="text" id="client_name" class="header-input" readonly
        value="<%= estimate.client_name || "" %>" />
    </div>

    <div class="table-wrapper">
      <table>
        <thead>
          <tr>
            <th rowspan="2" class="col-name">í’ˆ ëª…</th>
            <th rowspan="2" class="col-spec">ê·œ ê²©</th>
            <th rowspan="2" class="col-unit">ë‹¨ìœ„</th>
            <th rowspan="2" class="col-qty">ìˆ˜ëŸ‰</th>
            <th colspan="2">ì¬ ë£Œ ë¹„</th>
            <th colspan="2">ë…¸ ë¬´ ë¹„</th>
            <th colspan="2">ê²½ ë¹„</th>
            <th colspan="2">í•© ê³„</th>
            <th rowspan="2" class="col-note">ë¹„ ê³ </th>
          </tr>
          <tr class="sub-header">
            <th class="col-mu">ë‹¨ê°€</th>
            <th class="col-ma">ê¸ˆì•¡</th>
            <th class="col-lu">ë‹¨ê°€</th>
            <th class="col-la">ê¸ˆì•¡</th>
            <th class="col-eu">ë‹¨ê°€</th>
            <th class="col-ea">ê¸ˆì•¡</th>
            <th class="col-tu">ë‹¨ê°€</th>
            <th class="col-ta">ê¸ˆì•¡</th>
          </tr>
        </thead>

        <tbody>
            <% 
              let sumMaterialAmount = 0;
              let sumLaborAmount    = 0;
              let sumExpenseAmount  = 0;
              let sumTotalAmount    = 0;
            %>
            <% items.forEach(function(row, i) { 
                sumMaterialAmount += Number(row.material_amount || 0);
                sumLaborAmount    += Number(row.labor_amount || 0);
                sumExpenseAmount  += Number(row.expense_amount || 0);
                sumTotalAmount    += Number(row.total_amount || 0);
            %>
            <tr>
              <td class="text-left col-name">
                <input type="text" value="<%= row.item_name || "" %>" readonly />
              </td>

              <td class="text-left col-spec">
                <input type="text" value="<%= row.spec || "" %>" readonly />
              </td>

              <td class="col-unit">
                <input type="text" value="<%= row.unit || "" %>" readonly />
              </td>

              <td class="col-qty">
                <input type="text" value="<%= fmt(row.qty) %>" readonly />
              </td>

              <td class="col-mu">
                <input type="text" value="<%= fmt(row.material_unit) %>" readonly />
              </td>
              <td class="col-ma">
                <input type="text" value="<%= fmt(row.material_amount) %>" readonly />
              </td>

              <td class="col-lu">
                <input type="text" value="<%= fmt(row.labor_unit) %>" readonly />
              </td>
              <td class="col-la">
                <input type="text" value="<%= fmt(row.labor_amount) %>" readonly />
              </td>

              <td class="col-eu">
                <input type="text" value="<%= fmt(row.expense_unit) %>" readonly />
              </td>
              <td class="col-ea">
                <input type="text" value="<%= fmt(row.expense_amount) %>" readonly />
              </td>

              <td class="col-tu">
                <input type="text" value="<%= fmt(row.total_unit) %>" readonly />
              </td>
              <td class="col-ta">
                <input type="text" value="<%= fmt(row.total_amount) %>" readonly />
              </td>

              <td class="text-left col-note">
                <input type="text" value="<%= row.note || "" %>" readonly />
              </td>
            </tr>
          <% }); %>
        </tbody>

        <!-- âœ… í•©ê³„ í–‰ -->
        <tfoot>
          <tr class="total-row">
            <td class="col-name total-label">í•©ê³„</td>
            <td class="col-spec"></td>
            <td class="col-unit"></td>
            <td class="col-qty"></td>

            <td class="col-mu"></td>
            <td class="col-ma">
              <input type="text" value="<%= fmt(sumMaterialAmount) %>" readonly />
            </td>

            <td class="col-lu"></td>
            <td class="col-la">
              <input type="text" value="<%= fmt(sumLaborAmount) %>" readonly />
            </td>

            <td class="col-eu"></td>
            <td class="col-ea">
              <input type="text" value="<%= fmt(sumExpenseAmount) %>" readonly />
            </td>

            <td class="col-tu"></td>
            <td class="col-ta">
              <input type="text" value="<%= fmt(sumTotalAmount) %>" readonly />
            </td>

            <td class="col-note"></td>
          </tr>
        </tfoot>
      </table>
    </div>

    <div class="actions">
      <a href="/estimate" class="btn btn-outline">ëª©ë¡</a>
      <a href="/estimate/<%= estimate.id %>/edit" class="btn">ìˆ˜ì •</a>
      <button type="button" class="btn" onclick="window.print()">ì¸ì‡„</button>
      <button type="button" class="btn" onclick="window.location='/estimate/<%= estimate.id %>/excel'">
        ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
      </button>
    </div>
  </div>
</body>
</html>
