<link rel="stylesheet" href="/css/style.css">

<main id="estimate-show">
   <% 
    function fmt(n){ 
      if (n===null || n===undefined || n==="" ) return "" ; 
      const num = Number(n); 
      if (isNaN(num)) return n;
      if (num===0) return "" ; // 0이면 표시 안 함 
      
      return num.toLocaleString("ko-KR"); 
    }
    
    const safeFiles = Array.isArray(files) ? files : [];

    let sumMaterialAmount=0,
        sumLaborAmount=0,
        sumExpenseAmount=0, 
        sumTotalAmount=0; 
        
    (items || []).forEach((row)=> {
      sumMaterialAmount += Number(row.material_amount || 0);
      sumLaborAmount += Number(row.labor_amount || 0);
      sumExpenseAmount += Number(row.expense_amount || 0);
      sumTotalAmount += Number(row.total_amount || 0);
    });
  %>

  <div class="card">
    <div class="title">
      <%= estimate.title %>
    </div>

    <div class="meta-grid">
      <div>
        <div class="kv">
          <div class="k">견적번호</div>
          <div class="v">
            <%= estimate.estimate_no || "-" %>
          </div>
        </div>
        <div class="kv">
          <div class="k">거래처</div>
          <div class="v">
            <%= estimate.client_name || "-" %>
          </div>
        </div>
      </div>

      <div>
        <div class="kv">
          <div class="k">견적금액</div>
          <div class="v">
            <%= estimate.total_amount ? estimate.total_amount.toLocaleString("ko-KR") + " 원" : "-" %>
          </div>
        </div>
        <div class="kv">
          <div class="k">등록일</div>
          <div class="v">
            <%= estimate.created_at ? String(estimate.created_at).substring(0,19) : "-" %>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="title" style="font-size:13px; margin-bottom:8px;">견적 내역</div>

    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th rowspan="2" class="col-name">품명</th>
            <th rowspan="2" class="col-spec">규격</th>
            <th rowspan="2" class="col-unit">단위</th>
            <th rowspan="2" class="col-qty">수량</th>
            <th colspan="2">재료비</th>
            <th colspan="2">노무비</th>
            <th colspan="2">경비</th>
            <th colspan="2">합계</th>
            <th rowspan="2" class="col-note">비고</th>
          </tr>
          <tr>
            <th class="col-mu">단가</th>
            <th class="col-ma">금액</th>
            <th class="col-lu">단가</th>
            <th class="col-la">금액</th>
            <th class="col-eu">단가</th>
            <th class="col-ea">금액</th>
            <th class="col-tu">단가</th>
            <th class="col-ta">금액</th>
          </tr>
        </thead>

        <tbody>
          <% (items || []).forEach(function(row){ %>
            <tr>
              <td class="col-name">
                <%= row.item_name || "" %>
              </td>
              <td class="col-spec">
                <%= row.spec || "" %>
              </td>
              <td class="col-unit">
                <%= row.unit || "" %>
              </td>
              <td class="col-qty text-right">
                <%= fmt(row.qty) %>
              </td>
          
              <td class="col-mu text-right">
                <%= fmt(row.material_unit_price) %>
              </td>
              <td class="col-ma text-right">
                <%= fmt(row.material_amount) %>
              </td>
          
              <td class="col-lu text-right">
                <%= fmt(row.labor_unit_price) %>
              </td>
              <td class="col-la text-right">
                <%= fmt(row.labor_amount) %>
              </td>
          
              <td class="col-eu text-right">
                <%= fmt(row.expense_unit_price) %>
              </td>
              <td class="col-ea text-right">
                <%= fmt(row.expense_amount) %>
              </td>
          
              <td class="col-tu text-right">
                <%= fmt(row.total_unit_price) %>
              </td>
              <td class="col-ta text-right">
                <%= fmt(row.total_amount) %>
              </td>
          
              <td class="col-note">
                <%= row.note || "" %>
              </td>
            </tr>
            <% }) %>

        </tbody>

        <tfoot>
          <tr class="total-row">
            <td colspan="4" class="text-center">합계</td>
            <td></td>
            <td class="text-right">
              <%= fmt(sumMaterialAmount) %>
            </td>
            <td></td>
            <td class="text-right">
              <%= fmt(sumLaborAmount) %>
            </td>
            <td></td>
            <td class="text-right">
              <%= fmt(sumExpenseAmount) %>
            </td>
            <td></td>
            <td class="text-right">
              <%= fmt(sumTotalAmount) %>
            </td>
            <td></td>
          </tr>
        </tfoot>
      </table>
    </div>
  </div>
<!-- ✅ 첨부 파일 (상세보기: 다운로드만) -->
<div class="card">
  <div class="title" style="font-size:13px; margin-bottom:8px;">첨부 파일</div>

  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th class="text-center" style="width:80px;">ID</th>
          <th>원본 파일명</th>
          <!-- <th>저장 파일명</th> -->
          <th class="text-center" style="width:140px;">등록일</th>
        </tr>
      </thead>
      <tbody>
        <% if (safeFiles.length> 0) { %>
          <% safeFiles.forEach((f)=> { %>
            <tr>
              <td class="text-center">
                <%= f.id %>
              </td>
              <td class="nowrap"> 
                <a class="link" href="/estimate/files/<%= f.id %>/download">
                  <%= f.original_name || '-' %>
                </a>
              </td>
              <!-- <td class="nowrap">
                <%= f.stored_name || '-' %>
              </td> -->
              <td class="text-center nowrap">
                <%= f.created_at ? String(f.created_at).substring(0,10) : "-" %>
              </td>
            </tr>
            <% }) %>
              <% } else { %>
                <tr>
                  <td colspan="3" class="text-center" style="color: var(--muted); padding: 14px;">
                    첨부된 파일이 없습니다.
                  </td>
                </tr>
                <% } %>
      </tbody>
    </table>
  </div>
</div>

  
    

  </main>