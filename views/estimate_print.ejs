<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ê²¬ì ì„œ ì¸ì‡„</title>

  <style>
    /* ===== í™”ë©´ + ì¸ì‡„ ê³µí†µ ===== */
    body {
      font-family: system-ui;
      background: #fff;
      margin: 0;
    }

    /* ğŸ”¥ ìƒë‹¨ ì‹œìŠ¤í…œ ë¬¸êµ¬ ì™„ì „ ì œê±° (í™”ë©´/ì¸ì‡„ ëª¨ë‘) */
    header, nav, aside,
    .sidebar, .app-sidebar,
    .topbar, .app-header,
    .brand, .logo, .site-title {
      display: none !important;
    }

    .estimate-wrap {
      max-width: 1450px;
      margin: 0 auto;
      padding: 20px 24px 28px;
      box-sizing: border-box;
    }

    h1 {
      text-align: center;
      margin: 0 0 20px;
      letter-spacing: 4px;
    }

    .header-row {
      margin-bottom: 12px;
      font-size: 14px;
    }

    .header-row label {
      font-weight: 600;
      margin-right: 6px;
    }

    .header-row input {
      border: none;
      background: transparent;
      padding: 0;
      font-size: 14px;
      width: auto;
      max-width: 520px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 11px;
      table-layout: fixed; /* colgroup ê¸°ë°˜ ê³ ì • */
    }

    th, td {
      border: 1px solid #999;
      padding: 3px 4px;
      text-align: center;
      vertical-align: middle;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    thead th {
      background: #ddebf7;
      font-weight: 700;
    }

    tr.total-row td {
      font-weight: 800;
    }

    td.total-label {
      background: #eeeeee;
      text-align: left;
      padding-left: 8px;
    }

    /* ===== í…ìŠ¤íŠ¸ ì¢Œì¸¡ì •ë ¬ (í’ˆëª…/ê·œê²© ì „ìš©) ===== */
    td.text-left, th.text-left {
      text-align: left;
      padding-left: 6px;
    }
    
    /* ===== í•©ê³„ ì…€ ì „ìš© ===== */
    td.total-label {
      background: #eeeeee;
      text-align: center;          /* ê°€ìš´ë° ì •ë ¬ */
      letter-spacing: 0.8em;       /* ê¸€ì ì‚¬ì´ ë„ìš°ê¸° */
      padding-left: 0;             /* ê°€ìš´ë° ê¸°ì¤€ */
      font-weight: 800;
    }

    /* ===== ì»¬ëŸ¼ ë„ˆë¹„ ì œì–´ ===== */
    col.col-item { width: 230px; } /* í’ˆëª… ë„“ê²Œ */
    col.col-spec { width: 130px; } /* ê·œê²© ë„“ê²Œ */
    col.col-unit { width: 55px; }  /* ë‹¨ìœ„ ì¢ê²Œ */
    col.col-qty  { width: 60px; }  /* ìˆ˜ëŸ‰ ì¢ê²Œ */
    col.col-num  { width: 85px; }  /* ë‹¨ê°€/ê¸ˆì•¡ */
    col.col-note { width: 90px; }  /* ë¹„ê³  */

    /* ===== ìˆ«ì ìš°ì¸¡ì •ë ¬ ===== */
    td.num, th.num {
      text-align: right;
      padding-right: 6px;
    }

    /* (ì„ íƒ) í’ˆëª…ì€ ì¤„ë°”ê¿ˆ í—ˆìš©í•˜ê³  ì‹¶ìœ¼ë©´ ì•„ë˜ ì£¼ì„ í•´ì œ */
    /* td.item { white-space: normal; } */

    /* ===== ì¸ì‡„ ì „ìš© ===== */
    @page {
      size: A4 landscape;
      margin: 12mm;
    }

    @media print {
      body {
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
      }
      table, tr, td, th {
        page-break-inside: avoid;
      }
    }
  </style>
</head>

<body>
<%
  function fmt(n) {
    if (n === null || n === undefined || n === "") return "";
    const num = Number(n);
    if (isNaN(num)) return n;
    return num.toLocaleString("ko-KR");
  }

  // 0ì´ë©´ ê³µë€(ë‹¨ê°€/ê¸ˆì•¡ì— ì‚¬ìš©)
  function fmtZeroBlank(n) {
    if (n === null || n === undefined || n === "") return "";
    const num = Number(n);
    if (isNaN(num)) return n;
    if (num === 0) return "";
    return num.toLocaleString("ko-KR");
  }

  let sumMaterial = 0;
  let sumLabor = 0;
  let sumExpense = 0;
  let sumTotal = 0;
%>

<div class="estimate-wrap">
  <h1>ê²¬ ì  ë‚´ ì—­ ì„œ</h1>

  <div class="header-row">
    <label>ê³µì‚¬ëª… :</label>
    <input type="text" readonly value="<%= estimate.title %>" />
    &nbsp;&nbsp;
    <label>ë°œì£¼ì²˜ :</label>
    <input type="text" readonly value="<%= estimate.client_name || '' %>" />
  </div>

  <table>
    <colgroup>
      <col class="col-item">
      <col class="col-spec">
      <col class="col-unit">
      <col class="col-qty">

      <!-- ì¬ë£Œë¹„(ë‹¨ê°€/ê¸ˆì•¡) -->
      <col class="col-num">
      <col class="col-num">

      <!-- ë…¸ë¬´ë¹„(ë‹¨ê°€/ê¸ˆì•¡) -->
      <col class="col-num">
      <col class="col-num">

      <!-- ê²½ë¹„(ë‹¨ê°€/ê¸ˆì•¡) -->
      <col class="col-num">
      <col class="col-num">

      <!-- í•©ê³„(ë‹¨ê°€/ê¸ˆì•¡) -->
      <col class="col-num">
      <col class="col-num">

      <col class="col-note">
    </colgroup>

    <thead>
      <tr>
        <th rowspan="2">í’ˆëª…</th>
        <th rowspan="2">ê·œê²©</th>
        <th rowspan="2">ë‹¨ìœ„</th>
        <th rowspan="2">ìˆ˜ëŸ‰</th>
        <th colspan="2">ì¬ë£Œë¹„</th>
        <th colspan="2">ë…¸ë¬´ë¹„</th>
        <th colspan="2">ê²½ë¹„</th>
        <th colspan="2">í•©ê³„</th>
        <th rowspan="2">ë¹„ê³ </th>
      </tr>
      <tr>
        <th class="num">ë‹¨ê°€</th><th class="num">ê¸ˆì•¡</th>
        <th class="num">ë‹¨ê°€</th><th class="num">ê¸ˆì•¡</th>
        <th class="num">ë‹¨ê°€</th><th class="num">ê¸ˆì•¡</th>
        <th class="num">ë‹¨ê°€</th><th class="num">ê¸ˆì•¡</th>
      </tr>
    </thead>

    <tbody>
      <% items.forEach(row => {
        sumMaterial += Number(row.material_amount || 0);
        sumLabor += Number(row.labor_amount || 0);
        sumExpense += Number(row.expense_amount || 0);
        sumTotal += Number(row.total_amount || 0);
      %>
      <tr>
        <td class="text-left item"><%= row.item_name || "" %></td>
        <td class="text-left"><%= row.spec || "" %></td>
        <td><%= row.unit || "" %></td>
        <td class="num"><%= fmt(row.qty) %></td>

        <!-- âœ… ë‹¨ê°€/ê¸ˆì•¡: ìš°ì¸¡ì •ë ¬ + 0ì´ë©´ ê³µë€ -->
        <td class="num"><%= fmtZeroBlank(row.material_unit) %></td>
        <td class="num"><%= fmtZeroBlank(row.material_amount) %></td>

        <td class="num"><%= fmtZeroBlank(row.labor_unit) %></td>
        <td class="num"><%= fmtZeroBlank(row.labor_amount) %></td>

        <td class="num"><%= fmtZeroBlank(row.expense_unit) %></td>
        <td class="num"><%= fmtZeroBlank(row.expense_amount) %></td>

        <td class="num"><%= fmtZeroBlank(row.total_unit) %></td>
        <td class="num"><%= fmtZeroBlank(row.total_amount) %></td>

        <td><%= row.note || "" %></td>
      </tr>
      <% }) %>
    </tbody>

    <tfoot>
      <tr class="total-row">
        <!-- âœ… í•©ê³„: ìˆ˜ëŸ‰ ì¹¸ê¹Œì§€ ë³‘í•©(í’ˆëª…~ìˆ˜ëŸ‰ = 4ì¹¸) -->
        <td class="total-label" colspan="4">í•©ê³„</td>

        <!-- ì¬ë£Œë¹„ -->
        <td></td>
        <td class="num"><%= fmtZeroBlank(sumMaterial) %></td>

        <!-- ë…¸ë¬´ë¹„ -->
        <td></td>
        <td class="num"><%= fmtZeroBlank(sumLabor) %></td>

        <!-- ê²½ë¹„ -->
        <td></td>
        <td class="num"><%= fmtZeroBlank(sumExpense) %></td>

        <!-- í•©ê³„ -->
        <td></td>
        <td class="num"><%= fmtZeroBlank(sumTotal) %></td>

        <!-- ë¹„ê³  -->
        <td></td>
      </tr>
    </tfoot>
  </table>
</div>

<script>
  window.addEventListener("load", () => {
    const isHeadless =
      /HeadlessChrome/i.test(navigator.userAgent) ||
      /Puppeteer/i.test(navigator.userAgent);

    if (!isHeadless) {
      window.addEventListener("afterprint", () => window.close());
      window.print();
    }
  });
</script>

</body>
</html>
