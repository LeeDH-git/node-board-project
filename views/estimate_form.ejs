<link rel="stylesheet" href="/css/style.css">
<% 
  const isEdit=mode==="edit" ; 
  const safeEstimate=estimate || {}; 
  const ROWS=15; 
  const srcItems=Array.isArray(items) ?  items : []; 
  const safeItems=Array.from({ length: ROWS }, (_, i)=> srcItems[i] || {});
  const safeFiles = (typeof files !== 'undefined' && Array.isArray(files)) ? files : [];

  function fmt(n){
  if (n===null || n===undefined || n==="") return "";
  const num = Number(n);
  if (isNaN(num)) return n;
  return num.toLocaleString("ko-KR");
  }

  const formAction = isEdit ? `/estimate/${safeEstimate.id}/edit` : "/estimate";
  %>

  <% if (typeof error !=="undefined" && error) { %>
    <div class="section" style="border-color:#ef4444;">
      <div style="color:#ef4444; font-weight:700;">오류</div>
      <div style="margin-top:6px;">
        <%= error %>
      </div>
    </div>
    <% } %>

      <form action="<%= formAction %>" method="POST" id="estimate-form" enctype="multipart/form-data">
        <div class="section">
          <div class="section-title">기본 정보</div>

          <div class="grid">
            <div class="field span-2">
              <div class="label">견적번호</div>
              <input type="text" class="input" name="estimate_no"
                value="<%= safeEstimate.estimate_no || (typeof nextEstimateNo !== 'undefined' ? (nextEstimateNo || '') : '') %>"
                readonly />
              <div class="help">자동 생성됩니다. (형식: est-YYYY-NNN)</div>
            </div>

            <div class="field span-2">
              <div class="label">견적명(공사명) <span class="req">*</span></div>
              <input type="text" class="input" id="title" name="title" required value="<%= safeEstimate.title || '' %>"
                placeholder="예: ○○공사 토목 및 건축공사 견적" />
            </div>

            <div class="field span-2">
              <div class="label">거래처(발주처)</div>
              <input type="text" class="input" id="client_name" name="client_name"
                value="<%= safeEstimate.client_name || '' %>" placeholder="거래처 / 발주처" />
            </div>
          </div>
        </div>

        <div class="section">
          <div class="section-title">견적 내역</div>
          <div class="help">수량/단가 입력 시 금액과 합계가 자동 계산됩니다.</div>

          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th rowspan="2" class="col-name">품명</th>
                  <th rowspan="2" class="col-spec">규격</th>
                  <th rowspan="2" class="col-unit">단위</th>
                  <th rowspan="2" class="col-qty">수량</th>
                  <th colspan="2">재료비</th>
                  <th colspan="2">노무비</th>
                  <th colspan="2">경비</th>
                  <th colspan="2">합계</th>
                  <th rowspan="2" class="col-note">비고</th>
                </tr>
                <tr>
                  <th class="col-mu">단가</th>
                  <th class="col-ma">금액</th>
                  <th class="col-lu">단가</th>
                  <th class="col-la">금액</th>
                  <th class="col-eu">단가</th>
                  <th class="col-ea">금액</th>
                  <th class="col-tu">단가</th>
                  <th class="col-ta">금액</th>
                </tr>
              </thead>

              <tbody id="item-rows">
                <% safeItems.forEach(function(row, i){ %>
                  <tr>
                    <td class="col-name">
                      <input type="text" class="cell-input text-left" name="items[<%= i %>][item_name]"
                        value="<%= row.item_name || '' %>" />
                    </td>
                    <td class="col-spec">
                      <input type="text" class="cell-input text-left" name="items[<%= i %>][spec]"
                        value="<%= row.spec || '' %>" />
                    </td>
                    <td class="col-unit">
                      <input type="text" class="cell-input" name="items[<%= i %>][unit]"
                        value="<%= row.unit || '' %>" />
                    </td>
                    <td class="col-qty">
                      <input type="text" class="cell-input text-right qty" name="items[<%= i %>][qty]"
                        value="<%= fmt(row.qty) %>" />
                    </td>

                    <td class="col-mu">
                      <input type="text" class="cell-input text-right material-unit"
                        name="items[<%= i %>][material_unit]" value="<%= fmt(row.material_unit) %>" />
                    </td>
                    <td class="col-ma">
                      <input type="text" class="cell-input text-right material-amount"
                        name="items[<%= i %>][material_amount]" readonly value="<%= fmt(row.material_amount) %>" />
                    </td>

                    <td class="col-lu">
                      <input type="text" class="cell-input text-right labor-unit" name="items[<%= i %>][labor_unit]"
                        value="<%= fmt(row.labor_unit) %>" />
                    </td>
                    <td class="col-la">
                      <input type="text" class="cell-input text-right labor-amount" name="items[<%= i %>][labor_amount]"
                        readonly value="<%= fmt(row.labor_amount) %>" />
                    </td>

                    <td class="col-eu">
                      <input type="text" class="cell-input text-right expense-unit" name="items[<%= i %>][expense_unit]"
                        value="<%= fmt(row.expense_unit) %>" />
                    </td>
                    <td class="col-ea">
                      <input type="text" class="cell-input text-right expense-amount"
                        name="items[<%= i %>][expense_amount]" readonly value="<%= fmt(row.expense_amount) %>" />
                    </td>

                    <td class="col-tu">
                      <input type="text" class="cell-input text-right total-unit" name="items[<%= i %>][total_unit]"
                        readonly value="<%= fmt(row.total_unit) %>" />
                    </td>
                    <td class="col-ta">
                      <input type="text" class="cell-input text-right total-amount" name="items[<%= i %>][total_amount]"
                        readonly value="<%= fmt(row.total_amount) %>" />
                    </td>

                    <td class="col-note">
                      <input type="text" class="cell-input text-left" name="items[<%= i %>][note]"
                        value="<%= row.note || '' %>" />
                    </td>
                  </tr>
                  <% }) %>
              </tbody>

              <tfoot>
                <tr class="total-row">
                  <td class="text-center" colspan="4">합계</td>

                  <td></td>
                  <td><input type="text" class="cell-input text-right total-material-sum" readonly /></td>

                  <td></td>
                  <td><input type="text" class="cell-input text-right total-labor-sum" readonly /></td>

                  <td></td>
                  <td><input type="text" class="cell-input text-right total-expense-sum" readonly /></td>

                  <td></td>
                  <td><input type="text" class="cell-input text-right total-all-sum" readonly /></td>

                  <td></td>
                </tr>
              </tfoot>
            </table>
          </div>

          <div class="help">※ 빈 행은 저장 시 자동으로 제외됩니다.</div>
        </div>

      <!-- ✅ 첨부 파일 (하단 카드 1개 유지) -->
      <div class="card">
        <div class="title" style="font-size:13px; margin-bottom:8px;">첨부 파일</div>
      
        <% if (isEdit) { %>
          <div class="muted" style="margin-bottom:10px;">업로드는 수정 화면에서만 / 상세 화면에서는 다운로드만</div>
      
          <!-- ✅ 중첩 form 제거: 메인폼 안에서 업로드 버튼만 다른 action으로 보냄 -->
          <div style="display:flex; gap:10px; align-items:center; margin-bottom:12px;">
            <input type="file" name="file_upload" required />
            <button type="submit" class="btn btn-primary" formaction="/estimate/<%= safeEstimate.id %>/files"
              formmethod="post">업로드</button>
          </div>
      
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th class="text-center" style="width:80px;">ID</th>
                  <th>원본 파일명</th>
                  <th class="text-center" style="width:140px;">등록일</th>
                  <th class="text-center" style="width:110px;">관리</th>
                </tr>
              </thead>
              <tbody>
                <% if (safeFiles.length> 0) { %>
                  <% safeFiles.forEach((f)=> { %>
                    <tr>
                      <td class="text-center">
                        <%= f.id %>
                      </td>
                      <td class="nowrap">
                        <a class="link" href="/estimate/files/<%= f.id %>/download">
                          <%= f.original_name || '-' %>
                        </a>
                      </td>
                      <td class="text-center nowrap">
                        <%= f.created_at ? String(f.created_at).substring(0,10) : "-" %>
                      </td>
                      <td class="text-center">
                        <button type="submit" class="btn-danger" style="padding:6px 10px;"
                          formaction="/estimate/files/<%= f.id %>/delete" formmethod="post"
                          onclick="return confirm('삭제하시겠습니까?');">삭제</button>
                      </td>
                    </tr>
                    <% }) %>
                      <% } else { %>
                        <tr>
                          <td colspan="4" class="text-center" style="color: var(--muted); padding: 14px;">
                            첨부된 파일이 없습니다.
                          </td>
                        </tr>
                        <% } %>
              </tbody>
            </table>
          </div>
      
          <% } else { %>
            <div class="muted" style="margin-bottom:10px;">견적 저장 시 첨부가 함께 업로드됩니다. (여러 개 선택 가능)</div>
      
            <!-- ✅ 신규(create): 메인 저장 POST /estimate로 같이 전송 -->
            <input type="file" name="files" multiple />
            <div class="help">필요한 파일을 선택한 뒤, 하단 “견적 저장”을 누르세요.</div>
            <% } %>
      </div>


        <div class="footer">
          <div class="footer-right">
            <button type="submit" class="btn btn-primary">
              <%= isEdit ? "수정 내용 저장" : "견적 저장" %>
            </button>
          </div>
        </div>
      </form>

      <script>
        function uncomma(str) { return String(str).replace(/[^\d.-]/g, ""); }
        function formatNumberWithComma(num) {
          if (num === "" || num === null || num === undefined) return "";
          const n = parseFloat(num);
          if (isNaN(n)) return "";
          return n.toLocaleString("ko-KR");
        }
        function parseNumber(v) {
          const n = parseFloat(uncomma(v));
          return isNaN(n) ? 0 : n;
        }

        function recalcTotals() {
          let sumMaterial = 0, sumLabor = 0, sumExpense = 0, sumTotal = 0;

          document.querySelectorAll("#item-rows tr").forEach((tr) => {
            const ma = parseNumber(tr.querySelector(".material-amount")?.value);
            const la = parseNumber(tr.querySelector(".labor-amount")?.value);
            const ea = parseNumber(tr.querySelector(".expense-amount")?.value);
            const ta = parseNumber(tr.querySelector(".total-amount")?.value);
            sumMaterial += ma; sumLabor += la; sumExpense += ea; sumTotal += ta;
          });

          document.querySelector(".total-material-sum").value = formatNumberWithComma(sumMaterial);
          document.querySelector(".total-labor-sum").value = formatNumberWithComma(sumLabor);
          document.querySelector(".total-expense-sum").value = formatNumberWithComma(sumExpense);
          document.querySelector(".total-all-sum").value = formatNumberWithComma(sumTotal);
        }

        function recalcRow(tr) {
          const qty = parseNumber(tr.querySelector(".qty")?.value);
          const mu = parseNumber(tr.querySelector(".material-unit")?.value);
          const lu = parseNumber(tr.querySelector(".labor-unit")?.value);
          const eu = parseNumber(tr.querySelector(".expense-unit")?.value);

          const materialAmount = qty * mu;
          const laborAmount = qty * lu;
          const expenseAmount = qty * eu;
          const totalUnit = mu + lu + eu;
          const totalAmount = qty * totalUnit;

          tr.querySelector(".material-amount").value = formatNumberWithComma(materialAmount);
          tr.querySelector(".labor-amount").value = formatNumberWithComma(laborAmount);
          tr.querySelector(".expense-amount").value = formatNumberWithComma(expenseAmount);
          tr.querySelector(".total-unit").value = formatNumberWithComma(totalUnit);
          tr.querySelector(".total-amount").value = formatNumberWithComma(totalAmount);

          recalcTotals();
        }

        document.addEventListener("input", function (e) {
          const t = e.target;

          if (t.classList.contains("qty") ||
            t.classList.contains("material-unit") ||
            t.classList.contains("labor-unit") ||
            t.classList.contains("expense-unit")) {

            const raw = uncomma(t.value);
            t.value = formatNumberWithComma(raw);

            const tr = t.closest("tr");
            if (tr) recalcRow(tr);
          }

          if (t.tagName === "INPUT" && t.type === "text" &&
            !t.classList.contains("qty") &&
            !t.classList.contains("material-unit") &&
            !t.classList.contains("labor-unit") &&
            !t.classList.contains("expense-unit")) {
            t.value = t.value.trimStart();
          }
        });

        document.getElementById("estimate-form")?.addEventListener("submit", function () {
          document.querySelectorAll(".qty, .material-unit, .material-amount, .labor-unit, .labor-amount, .expense-unit, .expense-amount, .total-unit, .total-amount")
            .forEach((el) => { el.value = uncomma(el.value); });

          document.querySelectorAll("input[type='text']").forEach((el) => { el.value = el.value.trim(); });
        });

        recalcTotals();
      </script>