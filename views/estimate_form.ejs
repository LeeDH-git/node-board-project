<style>
  .section {
    border: 1px solid var(--border);
    border-radius: 12px;
    background: var(--panel);
    padding: 16px;
    margin-bottom: 12px;
  }

  .section-title {
    margin: 0 0 10px 0;
    font-size: 13px;
    font-weight: 650;
    letter-spacing: -0.01em;
    color: var(--text);
  }

  .help {
    margin: 6px 0 0;
    font-size: 12px;
    color: #9CA3AF;
    line-height: 1.5;
  }

  .grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
  }

  .span-2 {
    grid-column: 1 / span 2;
  }

  .field {
    display: flex;
    flex-direction: column;
    gap: 6px;
    padding: 10px 0;
    border-bottom: 1px solid var(--border);
  }

  .grid>.field:nth-last-child(-n+2) {
    border-bottom: none;
  }

  .label {
    font-size: 12px;
    color: var(--muted);
    font-weight: 700;
  }

  .req {
    color: #ef4444;
    font-weight: 700;
  }

  .input {
    border: 1px solid var(--border);
    border-radius: 10px;
    background: #fff;
    padding: 0 12px;
    height: 40px;
    font-size: 13.5px;
    color: var(--text);
  }

  .input:focus {
    outline: none;
    border-color: var(--text);
    box-shadow: var(--ring);
  }

  .input[readonly] {
    background: var(--bg);
  }

  /* ===== 견적 테이블 (FHD 최적 / 스크롤 최소화) ===== */
  .table-wrap {
    border: 2px solid rgba(17, 24, 39, 0.18);
    border-radius: 12px;
    background: #fff;
    margin-top: 10px;

    overflow-x: hidden;
    /* 기본은 스크롤 숨김 */
  }

  table {
    width: 100%;
    border-collapse: collapse;
    table-layout: fixed;
    font-size: 12.5px;
    border: 2px solid rgba(17, 24, 39, 0.18);
  }

  thead th {
    background: var(--bg);
    font-weight: 650;
    padding: 10px 8px;
    white-space: nowrap;
    text-align: center;
    border-bottom: 2px solid rgba(17, 24, 39, 0.12);
  }

  tbody td,
  tfoot td {
    padding: 8px 8px;
    text-align: center;
    vertical-align: middle;
    border-bottom: 2px solid rgba(17, 24, 39, 0.08);
    font-variant-numeric: tabular-nums;
  }

  table th,
  table td {
    border-right: 2px solid rgba(17, 24, 39, 0.10);
  }

  table th:last-child,
  table td:last-child {
    border-right: none;
  }

  tfoot td {
    border-top: 2px solid rgba(17, 24, 39, 0.14);
  }

  tr.total-row td {
    font-weight: 700;
    background: var(--bg);
  }

  /* ✅ 컬럼 폭 (show와 동일) */
  th.col-name,
  td.col-name {
    width: 16%;
  }

  th.col-spec,
  td.col-spec {
    width: 12%;
  }

  th.col-unit,
  td.col-unit {
    width: 4%;
  }

  th.col-qty,
  td.col-qty {
    width: 5%;
  }

  th.col-mu,
  td.col-mu,
  th.col-lu,
  td.col-lu,
  th.col-eu,
  td.col-eu,
  th.col-tu,
  td.col-tu {
    width: 5.5%;
  }

  th.col-ma,
  td.col-ma,
  th.col-la,
  td.col-la,
  th.col-ea,
  td.col-ea,
  th.col-ta,
  td.col-ta {
    width: 6.5%;
  }

  th.col-note,
  td.col-note {
    width: 9%;
  }

  .cell-input {
    width: 100%;
    box-sizing: border-box;
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 0 10px;
    height: 34px;
    font-size: 12.5px;
    background: #fff;
  }

  .cell-input:focus {
    outline: none;
    border-color: var(--text);
    box-shadow: var(--ring);
  }

  .cell-input[readonly] {
    background: var(--bg);
  }

  .text-left {
    text-align: left;
  }

  .text-right {
    text-align: right;
    padding-right: 14px;
    /* 숫자 잘림 방지 */
    white-space: nowrap;
  }

  .footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 10px;
    flex-wrap: wrap;
    margin-top: 14px;
  }

  .footer-right {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    align-items: center;
    justify-content: flex-end;
  }

  @media (max-width: 1500px) {
    .table-wrap {
      overflow-x: auto;
    }

    table {
      min-width: 1400px;
    }
  }

  @media (max-width: 760px) {
    .grid {
      grid-template-columns: 1fr;
    }

    .span-2 {
      grid-column: auto;
    }
  }
</style>
<!-- <link rel="stylesheet" href="/css/style.css"> -->
<% const isEdit=mode==="edit" ; const safeEstimate=estimate || {}; const ROWS=15; const srcItems=Array.isArray(items) ?
  items : []; const safeItems=Array.from({ length: ROWS }, (_, i)=> srcItems[i] || {});

  function fmt(n){
  if (n===null || n===undefined || n==="") return "";
  const num = Number(n);
  if (isNaN(num)) return n;
  return num.toLocaleString("ko-KR");
  }

  const formAction = isEdit ? `/estimate/${safeEstimate.id}/edit` : "/estimate";
  %>

  <% if (typeof error !=="undefined" && error) { %>
    <div class="section" style="border-color:#ef4444;">
      <div style="color:#ef4444; font-weight:700;">오류</div>
      <div style="margin-top:6px;">
        <%= error %>
      </div>
    </div>
    <% } %>

      <form action="<%= formAction %>" method="POST" id="estimate-form">
        <div class="section">
          <div class="section-title">기본 정보</div>

          <div class="grid">
            <div class="field span-2">
              <div class="label">견적번호</div>
              <input type="text" class="input" name="estimate_no"
                value="<%= safeEstimate.estimate_no || (typeof nextEstimateNo !== 'undefined' ? (nextEstimateNo || '') : '') %>"
                readonly />
              <div class="help">자동 생성됩니다. (형식: est-YYYY-NNN)</div>
            </div>

            <div class="field span-2">
              <div class="label">견적명(공사명) <span class="req">*</span></div>
              <input type="text" class="input" id="title" name="title" required value="<%= safeEstimate.title || '' %>"
                placeholder="예: ○○공사 토목 및 건축공사 견적" />
            </div>

            <div class="field span-2">
              <div class="label">거래처(발주처)</div>
              <input type="text" class="input" id="client_name" name="client_name"
                value="<%= safeEstimate.client_name || '' %>" placeholder="거래처 / 발주처" />
            </div>
          </div>
        </div>

        <div class="section">
          <div class="section-title">견적 내역</div>
          <div class="help">수량/단가 입력 시 금액과 합계가 자동 계산됩니다.</div>

          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th rowspan="2" class="col-name">품명</th>
                  <th rowspan="2" class="col-spec">규격</th>
                  <th rowspan="2" class="col-unit">단위</th>
                  <th rowspan="2" class="col-qty">수량</th>
                  <th colspan="2">재료비</th>
                  <th colspan="2">노무비</th>
                  <th colspan="2">경비</th>
                  <th colspan="2">합계</th>
                  <th rowspan="2" class="col-note">비고</th>
                </tr>
                <tr>
                  <th class="col-mu">단가</th>
                  <th class="col-ma">금액</th>
                  <th class="col-lu">단가</th>
                  <th class="col-la">금액</th>
                  <th class="col-eu">단가</th>
                  <th class="col-ea">금액</th>
                  <th class="col-tu">단가</th>
                  <th class="col-ta">금액</th>
                </tr>
              </thead>

              <tbody id="item-rows">
                <% safeItems.forEach(function(row, i){ %>
                  <tr>
                    <td class="col-name">
                      <input type="text" class="cell-input text-left" name="items[<%= i %>][item_name]"
                        value="<%= row.item_name || '' %>" />
                    </td>
                    <td class="col-spec">
                      <input type="text" class="cell-input text-left" name="items[<%= i %>][spec]"
                        value="<%= row.spec || '' %>" />
                    </td>
                    <td class="col-unit">
                      <input type="text" class="cell-input" name="items[<%= i %>][unit]"
                        value="<%= row.unit || '' %>" />
                    </td>
                    <td class="col-qty">
                      <input type="text" class="cell-input text-right qty" name="items[<%= i %>][qty]"
                        value="<%= fmt(row.qty) %>" />
                    </td>

                    <td class="col-mu">
                      <input type="text" class="cell-input text-right material-unit"
                        name="items[<%= i %>][material_unit]" value="<%= fmt(row.material_unit) %>" />
                    </td>
                    <td class="col-ma">
                      <input type="text" class="cell-input text-right material-amount"
                        name="items[<%= i %>][material_amount]" readonly value="<%= fmt(row.material_amount) %>" />
                    </td>

                    <td class="col-lu">
                      <input type="text" class="cell-input text-right labor-unit" name="items[<%= i %>][labor_unit]"
                        value="<%= fmt(row.labor_unit) %>" />
                    </td>
                    <td class="col-la">
                      <input type="text" class="cell-input text-right labor-amount" name="items[<%= i %>][labor_amount]"
                        readonly value="<%= fmt(row.labor_amount) %>" />
                    </td>

                    <td class="col-eu">
                      <input type="text" class="cell-input text-right expense-unit" name="items[<%= i %>][expense_unit]"
                        value="<%= fmt(row.expense_unit) %>" />
                    </td>
                    <td class="col-ea">
                      <input type="text" class="cell-input text-right expense-amount"
                        name="items[<%= i %>][expense_amount]" readonly value="<%= fmt(row.expense_amount) %>" />
                    </td>

                    <td class="col-tu">
                      <input type="text" class="cell-input text-right total-unit" name="items[<%= i %>][total_unit]"
                        readonly value="<%= fmt(row.total_unit) %>" />
                    </td>
                    <td class="col-ta">
                      <input type="text" class="cell-input text-right total-amount" name="items[<%= i %>][total_amount]"
                        readonly value="<%= fmt(row.total_amount) %>" />
                    </td>

                    <td class="col-note">
                      <input type="text" class="cell-input text-left" name="items[<%= i %>][note]"
                        value="<%= row.note || '' %>" />
                    </td>
                  </tr>
                  <% }) %>
              </tbody>

              <tfoot>
                <tr class="total-row">
                  <td class="text-center" colspan="4">합계</td>

                  <td></td>
                  <td><input type="text" class="cell-input text-right total-material-sum" readonly /></td>

                  <td></td>
                  <td><input type="text" class="cell-input text-right total-labor-sum" readonly /></td>

                  <td></td>
                  <td><input type="text" class="cell-input text-right total-expense-sum" readonly /></td>

                  <td></td>
                  <td><input type="text" class="cell-input text-right total-all-sum" readonly /></td>

                  <td></td>
                </tr>
              </tfoot>
            </table>
          </div>

          <div class="help">※ 빈 행은 저장 시 자동으로 제외됩니다.</div>
        </div>

        <div class="footer">
          <a href="/estimate" class="btn">목록으로</a>
          <div class="footer-right">
            <button type="submit" class="btn btn-primary">
              <%= isEdit ? "수정 내용 저장" : "견적 저장" %>
            </button>
          </div>
        </div>
      </form>

      <script>
        function uncomma(str) { return String(str).replace(/[^\d.-]/g, ""); }
        function formatNumberWithComma(num) {
          if (num === "" || num === null || num === undefined) return "";
          const n = parseFloat(num);
          if (isNaN(n)) return "";
          return n.toLocaleString("ko-KR");
        }
        function parseNumber(v) {
          const n = parseFloat(uncomma(v));
          return isNaN(n) ? 0 : n;
        }

        function recalcTotals() {
          let sumMaterial = 0, sumLabor = 0, sumExpense = 0, sumTotal = 0;

          document.querySelectorAll("#item-rows tr").forEach((tr) => {
            const ma = parseNumber(tr.querySelector(".material-amount")?.value);
            const la = parseNumber(tr.querySelector(".labor-amount")?.value);
            const ea = parseNumber(tr.querySelector(".expense-amount")?.value);
            const ta = parseNumber(tr.querySelector(".total-amount")?.value);
            sumMaterial += ma; sumLabor += la; sumExpense += ea; sumTotal += ta;
          });

          document.querySelector(".total-material-sum").value = formatNumberWithComma(sumMaterial);
          document.querySelector(".total-labor-sum").value = formatNumberWithComma(sumLabor);
          document.querySelector(".total-expense-sum").value = formatNumberWithComma(sumExpense);
          document.querySelector(".total-all-sum").value = formatNumberWithComma(sumTotal);
        }

        function recalcRow(tr) {
          const qty = parseNumber(tr.querySelector(".qty")?.value);
          const mu = parseNumber(tr.querySelector(".material-unit")?.value);
          const lu = parseNumber(tr.querySelector(".labor-unit")?.value);
          const eu = parseNumber(tr.querySelector(".expense-unit")?.value);

          const materialAmount = qty * mu;
          const laborAmount = qty * lu;
          const expenseAmount = qty * eu;
          const totalUnit = mu + lu + eu;
          const totalAmount = qty * totalUnit;

          tr.querySelector(".material-amount").value = formatNumberWithComma(materialAmount);
          tr.querySelector(".labor-amount").value = formatNumberWithComma(laborAmount);
          tr.querySelector(".expense-amount").value = formatNumberWithComma(expenseAmount);
          tr.querySelector(".total-unit").value = formatNumberWithComma(totalUnit);
          tr.querySelector(".total-amount").value = formatNumberWithComma(totalAmount);

          recalcTotals();
        }

        document.addEventListener("input", function (e) {
          const t = e.target;

          if (t.classList.contains("qty") ||
            t.classList.contains("material-unit") ||
            t.classList.contains("labor-unit") ||
            t.classList.contains("expense-unit")) {

            const raw = uncomma(t.value);
            t.value = formatNumberWithComma(raw);

            const tr = t.closest("tr");
            if (tr) recalcRow(tr);
          }

          if (t.tagName === "INPUT" && t.type === "text" &&
            !t.classList.contains("qty") &&
            !t.classList.contains("material-unit") &&
            !t.classList.contains("labor-unit") &&
            !t.classList.contains("expense-unit")) {
            t.value = t.value.trimStart();
          }
        });

        document.getElementById("estimate-form")?.addEventListener("submit", function () {
          document.querySelectorAll(".qty, .material-unit, .material-amount, .labor-unit, .labor-amount, .expense-unit, .expense-amount, .total-unit, .total-amount")
            .forEach((el) => { el.value = uncomma(el.value); });

          document.querySelectorAll("input[type='text']").forEach((el) => { el.value = el.value.trim(); });
        });

        recalcTotals();
      </script>