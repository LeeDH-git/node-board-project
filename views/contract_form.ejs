<!-- 계약 작성/수정 화면: /contract/new, /contract/:id/edit -->

<h3><%= contract ? "계약 수정" : "신규 계약 등록" %></h3>

<form
  action="<%= contract ? ('/contract/' + contract.id + '/edit') : '/contract' %>"
  method="post"
  enctype="multipart/form-data"
  class="mt-3"
>
  <!-- 1. 기본 정보 영역 -->
  <div class="border rounded p-3 mb-3">
    <div class="form-row">
      <!-- 연결 견적 ID (옵션) -->
      <div class="form-group col-md-3">
        <label>견적 ID (옵션)</label>
        <input
          type="number"
          name="estimate_id"
          class="form-control"
          value="<%= contract && contract.estimate_id ? contract.estimate_id : '' %>"
          placeholder="해당 견적 id"
        />
        <small class="form-text text-muted">
          특정 견적과 연결할 때만 입력 (없으면 비워둬도 됨)
        </small>
      </div>

      <!-- 계약번호 -->
      <div class="form-group col-md-3">
        <label>계약번호</label>
        <input
          type="text"
          name="contract_no"
          class="form-control"
          value="<%= contract && contract.contract_no ? contract.contract_no : '' %>"
          placeholder="예: MC-2025-001"
        />
      </div>

      <!-- 발주처 -->
      <div class="form-group col-md-3">
        <label>발주처</label>
        <input
          type="text"
          name="client_name"
          class="form-control"
          value="<%= contract && contract.client_name ? contract.client_name : '' %>"
          placeholder="발주처 / 거래처"
        />
      </div>

      <!-- 계약금액 -->
      <div class="form-group col-md-3">
        <label>계약금액</label>
        <input
          type="number"
          name="total_amount"
          class="form-control text-right"
          value="<%= contract && contract.total_amount ? contract.total_amount : '' %>"
          placeholder="숫자만 입력"
        />
      </div>
    </div>

    <!-- 계약명 (필수) -->
    <div class="form-group">
      <label>계약명 (공사명)<span class="text-danger">*</span></label>
      <input
        type="text"
        name="title"
        class="form-control"
        required
        value="<%= contract ? contract.title : '' %>"
        placeholder="예: ○○공사 토목 및 건축공사 계약"
      />
    </div>

    <!-- 공사 기간 -->
    <div class="form-row">
      <div class="form-group col-md-3">
        <label>착공일</label>
        <input
          type="date"
          name="start_date"
          class="form-control"
          value="<%= contract && contract.start_date ? contract.start_date : '' %>"
        />
      </div>
      <div class="form-group col-md-3">
        <label>준공일</label>
        <input
          type="date"
          name="end_date"
          class="form-control"
          value="<%= contract && contract.end_date ? contract.end_date : '' %>"
        />
      </div>
    </div>
  </div>

  <!-- 2. PDF 업로드 + 미리보기 -->
  <div class="border rounded p-3 mb-3">
    <h5 class="mb-3">계약서 PDF</h5>

    <div class="form-group">
      <label>계약서 PDF 파일 (선택)</label>
      <input
        type="file"
        name="pdf"
        accept="application/pdf"
        class="form-control-file"
      />
      <% if (contract && contract.pdf_filename) { %>
        <small class="form-text text-muted">
          현재 PDF가 등록되어 있습니다. 새 파일을 선택하면 기존 파일을 교체합니다.
        </small>
      <% } else { %>
        <small class="form-text text-muted">
          PDF를 업로드하면 저장 후 상세 화면에서 첫 페이지가 미리보기로 표시됩니다.
        </small>
      <% } %>
    </div>

    <% if (contract && contract.pdf_filename) { %>
      <div class="mt-3">
        <label>현재 등록된 PDF (1페이지 미리보기)</label>
        <div style="border:1px solid #ddd; border-radius:4px; overflow:hidden;">
          <embed
            src="/uploads/contracts/<%= contract.pdf_filename %>#page=1&zoom=page-width"
            type="application/pdf"
            width="100%"
            height="500px"
          >
        </div>
        <div class="mt-2">
          <a
            href="/uploads/contracts/<%= contract.pdf_filename %>"
            target="_blank"
          >
            전체 PDF 새창으로 열기
          </a>
        </div>
      </div>
    <% } %>
  </div>

  <!-- 3. 수기 계약서 작성 영역 -->
  <div class="border rounded p-3 mb-3">
    <h5 class="mb-3">수기 계약서 내용</h5>
    <p class="text-muted" style="font-size: 0.9rem;">
      PDF를 업로드하지 않고, 아래에 계약서 전문을 수기로 작성해서 관리할 수도 있습니다.<br />
      PDF와 수기 내용을 둘 다 사용할 수도 있습니다.
    </p>

    <div class="form-group">
      <textarea
        name="body_text"
        class="form-control"
        rows="16"
        placeholder="계약서 조항을 텍스트로 직접 작성하려면 여기에 입력하세요."
      ><%= contract && contract.body_text ? contract.body_text : '' %></textarea>
    </div>
  </div>

  <p class="text-muted" style="font-size: 0.9rem;">
    ※ PDF 파일 또는 수기 계약서 내용 중 하나 이상은 입력하는 것을 권장합니다.
  </p>

  <div class="mt-3 d-flex justify-content-between">
    <a href="/contract" class="btn btn-secondary">목록으로</a>
    <div>
      <% if (contract) { %>
        <form
          action="/contract/<%= contract.id %>/delete"
          method="post"
          style="display:inline-block;"
          onsubmit="return confirm('정말 이 계약을 삭제하시겠습니까?');"
        >
          <button type="submit" class="btn btn-outline-danger mr-2">
            삭제
          </button>
        </form>
      <% } %>
      <button type="submit" class="btn btn-primary">
        <%= contract ? "수정 내용 저장" : "계약 등록" %>
      </button>
    </div>
  </div>
</form>
