<link rel="stylesheet" href="/css/style.css">

<main id="contract-form">
<% if (typeof error !=="undefined" && error) { %>
  <div class="alert">
    <div style="font-weight:800; margin-bottom:6px;">오류</div>
    <div>
      <%= error %>
    </div>
  </div>
  <% } %>

    <form action="<%= contract && contract.id ? ('/contract/' + contract.id + '/edit') : '/contract' %>" method="post"
      enctype="multipart/form-data">

      <!-- ✅ 카드 1: 기본 정보 -->
      <div class="card">
        <div class="title">기본 정보</div>

        <div class="grid">

          <!-- ✅ 견적ID 제거 (요청사항) -->

          <div class="field">
            <div class="label">계약번호</div>
            <input type="text" name="contract_no" class="input" value="<%=
                 (contract && contract.contract_no) ? contract.contract_no
                 : (typeof nextContractNo !== 'undefined' ? (nextContractNo || '') : '')
               %>" readonly />
            <div class="help">자동 생성됩니다. (형식: ctr-YYYY-NNN)</div>
          </div>

          <div class="field">
            <div class="label">발주처</div>
            <input type="text" name="client_name" class="input"
              value="<%= contract && contract.client_name ? contract.client_name : '' %>" placeholder="발주처 / 거래처" />
          </div>

          <div class="field">
            <div class="label">계약금액</div>
            <input type="number" name="total_amount" class="input"
              value="<%= contract && contract.total_amount ? contract.total_amount : '' %>" placeholder="숫자만 입력" min="0"
              step="1" />
          </div>

          <div class="field span-2">
            <div class="label">계약명 (공사명) <span class="req">*</span></div>
            <input type="text" name="title" class="input" required value="<%= contract ? (contract.title || '') : '' %>"
              placeholder="예: ○○공사 토목 및 건축공사 계약" />
          </div>

          <div class="field">
            <div class="label">착공일</div>
            <input type="date" name="start_date" class="input"
              value="<%= contract && contract.start_date ? contract.start_date : '' %>" />
          </div>

          <div class="field">
            <div class="label">준공일</div>
            <input type="date" name="end_date" class="input"
              value="<%= contract && contract.end_date ? contract.end_date : '' %>" />
          </div>

        </div>
      </div>

      <!-- ✅ 카드 2: 계약서 PDF -->
      <div class="card">
        <div class="section-title">계약서 PDF</div>

        <div class="field" style="border-bottom:none;">
          <div class="label">계약서 PDF 파일 (선택)</div>
          <input type="file" name="pdf" accept="application/pdf" class="file" />

          <% if (contract && contract.pdf_filename) { %>
            <div class="help">현재 PDF가 등록되어 있습니다. 새 파일을 선택하면 기존 파일을 교체합니다.</div>
            <% } else { %>
              <div class="help">PDF를 업로드하면 저장 후 상세 화면에서 첫 페이지가 미리보기로 표시됩니다.</div>
              <% } %>
        </div>

        <% if (contract && contract.pdf_filename) { %>
          <div style="margin-top: 12px;">
            <div class="label" style="margin-bottom:6px;">현재 등록된 PDF (1페이지 미리보기)</div>
            <div class="pdf-box">
              <embed class="pdf-embed" src="/uploads/contracts/<%= contract.pdf_filename %>#page=1&zoom=page-width"
                type="application/pdf">
            </div>
            <div style="margin-top: 8px;">
              <a class="link" href="/uploads/contracts/<%= contract.pdf_filename %>" target="_blank">
                전체 PDF 새창으로 열기
              </a>
            </div>
          </div>
          <% } %>
      </div>

      <!-- ✅ 카드 3: 수기 계약서 내용 -->
      <div class="card">
        <div class="section-title">수기 계약서 내용</div>

        <div class="help" style="margin-top:0;">
          PDF를 업로드하지 않고 아래에 계약서 전문을 수기로 작성해서 관리할 수도 있습니다.
          PDF와 수기 내용을 둘 다 사용할 수도 있습니다.
        </div>

        <div class="field" style="margin-top:10px; border-bottom:none;">
          <textarea name="body_text" class="textarea" rows="16"
            placeholder="계약서 조항을 텍스트로 직접 작성하려면 여기에 입력하세요."><%= contract && contract.body_text ? contract.body_text : '' %></textarea>
        </div>

        <div class="help">※ PDF 파일 또는 수기 계약서 내용 중 하나 이상은 입력하는 것을 권장합니다.</div>
      </div>

      <!-- ✅ 하단 버튼 -->
      <div class="footer">
        <a href="/contract" class="btn">목록으로</a>
        <div class="footer-right">
          <button type="submit" class="btn btn-primary">
            <%= contract ? "수정 내용 저장" : "계약 등록" %>
          </button>
        </div>
      </div>

    </form>
</main>